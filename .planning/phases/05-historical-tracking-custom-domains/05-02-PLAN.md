---
phase: 05-historical-tracking-custom-domains
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/user_domain.py
  - backend/app/routers/custom_domains.py
  - backend/app/main.py
  - backend/alembic/versions/05_02_user_domains.py
autonomous: true
requirements: [DOM-03, DOM-04]

must_haves:
  truths:
    - "user_domains and user_domain_tickers tables exist with RLS enforced"
    - "authenticated user can create a custom domain with ticker list"
    - "invalid tickers are rejected during POST /api/domains/custom"
    - "user can only read/update/delete their own domains"
    - "GET /api/domains/custom returns only the requesting user's domains"
  artifacts:
    - path: "backend/app/models/user_domain.py"
      provides: "UserDomain + UserDomainTicker SQLAlchemy models"
      contains: "class UserDomain"
    - path: "backend/app/routers/custom_domains.py"
      provides: "CRUD routes for custom domains"
      exports: ["router"]
    - path: "backend/alembic/versions/05_02_user_domains.py"
      provides: "Migration: user_domains + user_domain_tickers + RLS"
  key_links:
    - from: "backend/app/routers/custom_domains.py"
      to: "backend/app/models/user_domain.py"
      via: "async session query/insert/delete"
      pattern: "UserDomain|UserDomainTicker"
    - from: "backend/app/routers/custom_domains.py"
      to: "validate_ticker"
      via: "asyncio run_in_executor for yfinance .info check"
      pattern: "run_in_executor.*validate_ticker"
---

<objective>
Create user_domains/user_domain_tickers models, migration with RLS, and CRUD API routes including ticker validation.

Purpose: Let users define their own stock groups to rank alongside built-in domains.
Output: Two new DB tables with RLS; four API routes; yfinance-backed ticker validation.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@backend/app/models/stock.py
@backend/app/routers/health.py
@backend/app/main.py
@backend/alembic/versions/81cb55ab1baf_initial_schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: UserDomain models + Alembic migration with RLS</name>
  <files>backend/app/models/user_domain.py, backend/alembic/versions/05_02_user_domains.py</files>
  <action>
Create `backend/app/models/user_domain.py` using SQLAlchemy 2.0 syntax:

```python
class UserDomain(Base):
    __tablename__ = "user_domains"
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    user_id: Mapped[UUID] = mapped_column(UUID(as_uuid=True), nullable=False)
    name: Mapped[str] = mapped_column(Text, nullable=False)
    created_at: Mapped[datetime] = mapped_column(TIMESTAMPTZ, server_default=func.now())
    tickers: Mapped[list["UserDomainTicker"]] = relationship(back_populates="domain", cascade="all, delete-orphan")

class UserDomainTicker(Base):
    __tablename__ = "user_domain_tickers"
    domain_id: Mapped[int] = mapped_column(Integer, ForeignKey("user_domains.id", ondelete="CASCADE"), primary_key=True)
    ticker: Mapped[str] = mapped_column(String(10), primary_key=True)
    domain: Mapped["UserDomain"] = relationship(back_populates="tickers")
```

Create Alembic migration `backend/alembic/versions/05_02_user_domains.py` — write upgrade/downgrade manually (NO autogenerate):

upgrade():
1. `op.create_table("user_domains", ...)` — id SERIAL PK, user_id UUID NOT NULL, name TEXT NOT NULL, created_at TIMESTAMPTZ DEFAULT now()
2. `op.create_index("ix_user_domains_user_id", "user_domains", ["user_id"])`
3. `op.create_table("user_domain_tickers", ...)` — domain_id INT FK → user_domains.id ON DELETE CASCADE, ticker VARCHAR(10), PK(domain_id, ticker)
4. RLS via raw SQL (auth.users FK must use op.execute — not autogenerate):
```python
op.execute("ALTER TABLE user_domains ENABLE ROW LEVEL SECURITY")
op.execute("ALTER TABLE user_domain_tickers ENABLE ROW LEVEL SECURITY")
op.execute("""CREATE POLICY own_domains ON user_domains FOR ALL TO authenticated
    USING ((select auth.uid()) = user_id)
    WITH CHECK ((select auth.uid()) = user_id)""")
op.execute("""CREATE POLICY own_tickers ON user_domain_tickers FOR ALL TO authenticated
    USING (domain_id IN (SELECT id FROM user_domains WHERE user_id = (select auth.uid())))""")
```

downgrade(): drop policies, drop tables in reverse order.

Run: `cd backend && alembic upgrade head`
  </action>
  <verify>
    cd backend && alembic upgrade head
    python -c "from app.models.user_domain import UserDomain, UserDomainTicker; print('OK')"
  </verify>
  <done>Migration applies; both tables visible in Supabase with RLS enabled; models importable</done>
</task>

<task type="auto">
  <name>Task 2: Custom domain CRUD routes + ticker validation</name>
  <files>backend/app/routers/custom_domains.py, backend/app/main.py</files>
  <action>
Create `backend/app/routers/custom_domains.py`:

Routes (all require `get_current_user` dependency from Phase 4 auth):
- `GET /api/domains/custom` — return user's domains with tickers list
- `POST /api/domains/custom` — body: `{name: str, tickers: list[str]}`, validate all tickers, create domain
- `PUT /api/domains/custom/{id}` — body: `{tickers: list[str]}`, validate, replace tickers; 404 if not owned
- `DELETE /api/domains/custom/{id}` — delete domain; 404 if not owned

Ticker validation (DOM-04):
```python
import asyncio
import yfinance as yf

def _validate_ticker_sync(symbol: str) -> bool:
    try:
        info = yf.Ticker(symbol.upper()).info
        return bool(info.get("shortName") or info.get("longName"))
    except Exception:
        return False

async def validate_ticker(symbol: str) -> bool:
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(None, _validate_ticker_sync, symbol)
```

For POST/PUT: validate all tickers concurrently with `asyncio.gather(*[validate_ticker(t) for t in tickers])`. Return 422 with `{"detail": "Invalid tickers: FAKE, XXX"}` if any fail.

Ownership check for PUT/DELETE: query `WHERE id=domain_id AND user_id=current_user.id` — raise 404 if not found (do not leak existence to other users).

Register router in `backend/app/main.py`:
```python
from app.routers.custom_domains import router as custom_domains_router
app.include_router(custom_domains_router, prefix="/api")
```
  </action>
  <verify>
    cd backend && python -c "from app.routers.custom_domains import router; print('OK')"
    # Start server: uvicorn app.main:app --reload
    # GET /api/domains/custom (with auth header) → 200 []
    # POST /api/domains/custom {name: "Test", tickers: ["FAKE999"]} → 422
  </verify>
  <done>All four routes registered; invalid ticker returns 422; valid ticker creates domain; user cannot access other users' domains</done>
</task>

</tasks>

<verification>
- `alembic upgrade head` succeeds
- user_domains + user_domain_tickers tables in Supabase with RLS policies visible
- `GET /api/domains/custom` returns 200 with empty list for new user
- `POST /api/domains/custom` with invalid ticker symbol returns 422
- `POST /api/domains/custom` with valid ticker creates domain and returns it
- `DELETE /api/domains/custom/{other_user_id}` returns 404 (RLS / ownership check)
</verification>

<success_criteria>
Both tables exist with RLS; four CRUD routes work; ticker validation rejects unknown symbols via yfinance.
</success_criteria>

<output>
After completion, create `.planning/phases/05-historical-tracking-custom-domains/05-02-SUMMARY.md`
</output>
