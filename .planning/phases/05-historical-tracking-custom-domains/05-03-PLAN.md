---
phase: 05-historical-tracking-custom-domains
plan: 03
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - backend/app/routers/history.py
  - backend/app/main.py
  - frontend/src/components/ScoreHistoryChart.tsx
  - frontend/src/components/TrendBadge.tsx
  - frontend/src/pages/HistoryPage.tsx
  - frontend/src/router.tsx
autonomous: true
requirements: [HIST-02, HIST-03]

must_haves:
  truths:
    - "GET /api/history/{ticker}?days=30 returns list of {snap_date, composite_score, rank, trend_slope}"
    - "ScoreHistoryChart renders a line chart of composite_score over time"
    - "TrendBadge shows Up/Down/Flat based on the most recent trend_slope"
    - "Navigating to /history/:ticker shows the chart for that ticker"
  artifacts:
    - path: "backend/app/routers/history.py"
      provides: "GET /api/history/{ticker}"
      exports: ["router"]
    - path: "frontend/src/components/ScoreHistoryChart.tsx"
      provides: "Recharts LineChart for score history"
    - path: "frontend/src/components/TrendBadge.tsx"
      provides: "Trend direction badge component"
    - path: "frontend/src/pages/HistoryPage.tsx"
      provides: "Route page wiring chart + badge"
  key_links:
    - from: "frontend/src/pages/HistoryPage.tsx"
      to: "backend GET /api/history/{ticker}"
      via: "TanStack Query useQuery"
      pattern: "useQuery.*history"
    - from: "frontend/src/router.tsx"
      to: "frontend/src/pages/HistoryPage.tsx"
      via: "TanStack Router route definition"
      pattern: "/history/:ticker"
---

<objective>
Add history API endpoint and frontend history chart with trend badge.

Purpose: Give users visibility into a stock's score trajectory over time.
Output: Backend history route; Recharts line chart page; trend Up/Down/Flat badge.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@backend/app/routers/health.py
@backend/app/main.py
@frontend/src/router.tsx
@frontend/src/components/StockCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: GET /api/history/{ticker} backend route</name>
  <files>backend/app/routers/history.py, backend/app/main.py</files>
  <action>
Create `backend/app/routers/history.py`:

```python
from fastapi import APIRouter, Depends, Query
from sqlalchemy import select
from app.models.daily_snapshot import DailySnapshot
from app.database import get_db
from datetime import date, timedelta

router = APIRouter()

@router.get("/history/{ticker}")
async def get_history(
    ticker: str,
    days: int = Query(default=30, ge=1, le=365),
    db=Depends(get_db),
):
    since = date.today() - timedelta(days=days)
    result = await db.execute(
        select(DailySnapshot)
        .where(DailySnapshot.ticker == ticker.upper())
        .where(DailySnapshot.snap_date >= since)
        .order_by(DailySnapshot.snap_date)
    )
    rows = result.scalars().all()
    return [
        {
            "snap_date": r.snap_date.isoformat(),
            "composite_score": r.composite_score,
            "rank": r.rank,
            "trend_slope": r.trend_slope,
        }
        for r in rows
    ]
```

Register in `backend/app/main.py`:
```python
from app.routers.history import router as history_router
app.include_router(history_router, prefix="/api")
```

No auth required on this route (history is public data, tied to system domains not user data).
  </action>
  <verify>
    cd backend && python -c "from app.routers.history import router; print('OK')"
    # curl http://localhost:8000/api/history/AAPL?days=30
    # Returns [] if no snapshots yet (acceptable — job hasn't run)
  </verify>
  <done>Route registered; returns list of snapshot objects ordered by date; empty list for tickers with no history</done>
</task>

<task type="auto">
  <name>Task 2: ScoreHistoryChart, TrendBadge, HistoryPage, router wiring</name>
  <files>frontend/src/components/ScoreHistoryChart.tsx, frontend/src/components/TrendBadge.tsx, frontend/src/pages/HistoryPage.tsx, frontend/src/router.tsx</files>
  <action>
Install recharts: `cd frontend && npm install recharts`

Create `frontend/src/components/TrendBadge.tsx`:
- Props: `slope: number`
- slope > 0.5 → green badge "↑ Up"
- slope < -0.5 → red badge "↓ Down"
- else → gray badge "→ Flat"
- Use Tailwind classes for color (text-green-600, text-red-600, text-gray-500)

Create `frontend/src/components/ScoreHistoryChart.tsx`:
- Props: `ticker: string`
- TanStack Query `useQuery` fetching `/api/history/${ticker}?days=30`
- Loading state: "Loading..." text
- Empty state: "No history available yet."
- Recharts `LineChart` with `ResponsiveContainer` (width="100%" height={300}):
  - XAxis: `dataKey="snap_date"` with `type="category"` (ISO date strings)
  - YAxis: domain [0, 100]
  - Line: `dataKey="composite_score"` dot={false} strokeWidth={2}
  - CartesianGrid, Tooltip
- Below chart: render `<TrendBadge slope={data[data.length-1].trend_slope} />` if data.length > 0

Create `frontend/src/pages/HistoryPage.tsx`:
- TanStack Router: read `ticker` param from route params
- Render `<h1>{ticker} Score History</h1>` + `<ScoreHistoryChart ticker={ticker} />`
- Back link to previous page

Wire into `frontend/src/router.tsx`:
- Add route `/history/$ticker` → `HistoryPage`
- Update StockCard (or wherever stock items are displayed) to navigate to `/history/${ticker}` on click — if StockCard already has an onClick or modal trigger, add history nav alongside it (do not remove existing behavior)
  </action>
  <verify>
    cd frontend && npm run build
    # No TypeScript errors
    # Navigate to /history/AAPL in browser → chart renders (empty or with data)
    # TrendBadge shows correct label for slope values
  </verify>
  <done>npm run build succeeds; /history/:ticker route renders ScoreHistoryChart and TrendBadge; recharts in package.json</done>
</task>

</tasks>

<verification>
- `GET /api/history/AAPL?days=30` returns 200 with list (empty is fine pre-snapshot)
- `npm run build` passes with no errors
- `/history/AAPL` page renders without crash
- TrendBadge renders correct text for slope > 0.5, < -0.5, in between
</verification>

<success_criteria>
History endpoint live; Recharts chart renders on /history/:ticker; TrendBadge displays correct direction.
</success_criteria>

<output>
After completion, create `.planning/phases/05-historical-tracking-custom-domains/05-03-SUMMARY.md`
</output>
