---
phase: 04-authentication-personalization
plan: 04
type: execute
wave: 3
depends_on: [04-02, 04-03]
files_modified:
  - frontend/src/routes/_authenticated/dashboard.tsx
  - frontend/src/components/DomainSelector.tsx
autonomous: true
requirements: [AUTH-04]

must_haves:
  truths:
    - "On login, dashboard loads user's saved domain filter from /api/preferences"
    - "Changing domain selection saves new list to /api/preferences"
    - "Domain filter state is user-specific (not shared across accounts)"
  artifacts:
    - path: "frontend/src/routes/_authenticated/dashboard.tsx"
      provides: "Loads preferences on mount, passes to DomainSelector"
      contains: "api/preferences"
    - path: "frontend/src/components/DomainSelector.tsx"
      provides: "Calls PUT /api/preferences on selection change"
      contains: "PUT"
  key_links:
    - from: "frontend/src/routes/_authenticated/dashboard.tsx"
      to: "/api/preferences"
      via: "fetch GET on mount with Authorization header"
      pattern: "Authorization.*Bearer"
    - from: "frontend/src/components/DomainSelector.tsx"
      to: "/api/preferences"
      via: "fetch PUT on selection change"
      pattern: "PUT.*preferences"
---

<objective>
Wire domain preference persistence: load saved domains on login, save on change via /api/preferences.

Purpose: Users see their domain filter restored after login without re-selecting manually.
Output: DomainSelector reads from and writes to /api/preferences using the user's JWT.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@frontend/src/components/DomainSelector.tsx
@frontend/src/routes/_authenticated/dashboard.tsx
@.planning/phases/04-authentication-personalization/04-02-SUMMARY.md
@.planning/phases/04-authentication-personalization/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Load preferences on dashboard mount</name>
  <files>frontend/src/routes/_authenticated/dashboard.tsx</files>
  <action>
    In `dashboard.tsx`, add a TanStack Query query (or plain useEffect) to GET /api/preferences on mount:

    ```ts
    const { data: session } = await supabase.auth.getSession()  // already available from route guard
    ```

    Use `useQuery` from `@tanstack/react-query`:
    ```tsx
    const { data: prefs } = useQuery({
      queryKey: ['preferences'],
      queryFn: async () => {
        const { data: { session } } = await supabase.auth.getSession()
        const res = await fetch('/api/preferences', {
          headers: { Authorization: `Bearer ${session!.access_token}` },
        })
        return res.json() as Promise<{ domains: string[] }>
      },
    })
    ```

    Pass `prefs?.domains` as the initial `selectedDomains` value to DomainSelector (or as the initial state). If prefs is loading, use an empty array as default.

    The backend URL must use the same base URL as the existing health/ranking fetches — derive it from the same pattern already in App.tsx or dashboard.tsx.
  </action>
  <verify>
    After logging in, check the Network tab in browser DevTools: a GET to /api/preferences fires on dashboard load and returns `{"domains": [...]}`.
  </verify>
  <done>Dashboard fetches preferences on mount; DomainSelector initialized with user's saved domain list</done>
</task>

<task type="auto">
  <name>Task 2: Save preferences on domain selection change</name>
  <files>frontend/src/components/DomainSelector.tsx</files>
  <action>
    In `DomainSelector.tsx`, add a `useMutation` (or debounced fetch) that fires PUT /api/preferences whenever the selected domains change:

    ```tsx
    import { useMutation } from '@tanstack/react-query'
    import { supabase } from '../lib/supabase'

    const savePref = useMutation({
      mutationFn: async (domains: string[]) => {
        const { data: { session } } = await supabase.auth.getSession()
        await fetch('/api/preferences', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${session!.access_token}`,
          },
          body: JSON.stringify({ domains }),
        })
      },
    })
    ```

    Call `savePref.mutate(newDomains)` inside the existing selection-change handler (wherever the domain toggle is handled). Do not debounce — fire immediately on change. No loading spinner needed.

    Do not change DomainSelector's existing prop interface beyond adding whatever is minimally required to thread the mutation through.
  </action>
  <verify>
    Toggle a domain in the UI. Check Network tab: a PUT to /api/preferences fires with body `{"domains": [...]}` and returns 200. After page refresh and re-login, the same domain selection is restored.
  </verify>
  <done>Domain selection changes trigger PUT /api/preferences; saved list restored on next login</done>
</task>

</tasks>

<verification>
Manual test:
1. Login with account A, select domains ["tech", "health"], refresh — same domains selected.
2. Login with account B (different) — domains are independent.
</verification>

<success_criteria>
- Saved domain list loads on dashboard mount for authenticated user
- Changing domain selection fires PUT /api/preferences
- After logout and re-login, previous domain selection is restored
- Different users see their own domain lists (RLS enforced)
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-personalization/04-04-SUMMARY.md`
</output>
