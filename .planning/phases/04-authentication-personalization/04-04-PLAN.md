---
phase: 04-authentication-personalization
plan: 04
type: execute
wave: 3
depends_on: [04-02, 04-03]
files_modified:
  - frontend/src/routes/_authenticated/dashboard.tsx
  - frontend/src/hooks/usePreferences.ts
autonomous: true
requirements: [AUTH-04]

must_haves:
  truths:
    - "On login, the user's saved domain preference is loaded and the matching domain tab is pre-selected"
    - "When user changes domain tab, the new domain is auto-saved to /api/preferences"
    - "If saved domain is not in available list, silently fall back to first available domain"
    - "Unauthenticated users who were viewing a domain have that selection saved as preference on login"
    - "New users with no saved preference default to first domain in list"
  artifacts:
    - path: "frontend/src/hooks/usePreferences.ts"
      provides: "Hook that reads/writes domain preferences via /api/preferences"
    - path: "frontend/src/routes/_authenticated/dashboard.tsx"
      provides: "Updated dashboard using usePreferences to initialize and persist activeDomain"
  key_links:
    - from: "frontend/src/hooks/usePreferences.ts"
      to: "backend /api/preferences"
      via: "fetch with Authorization: Bearer <token>"
      pattern: "Authorization.*Bearer"
    - from: "frontend/src/routes/_authenticated/dashboard.tsx"
      to: "frontend/src/hooks/usePreferences.ts"
      via: "usePreferences hook"
      pattern: "usePreferences"
---

<objective>
Wire domain preference load/save between the dashboard and /api/preferences.

Purpose: Fulfills AUTH-04 — user's domain selection persists across sessions and syncs on change.
Output: Dashboard initializes activeDomain from saved preferences; domain changes auto-save.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/04-authentication-personalization/04-CONTEXT.md
@frontend/src/routes/_authenticated/dashboard.tsx
@backend/app/routers/preferences.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: usePreferences hook</name>
  <files>frontend/src/hooks/usePreferences.ts</files>
  <action>
    Create `frontend/src/hooks/usePreferences.ts`:

    ```ts
    import { useEffect, useState, useCallback } from 'react'
    import { supabase } from '../lib/supabase'

    const API_BASE = import.meta.env.VITE_API_URL ?? 'http://localhost:8000'

    async function getAuthHeader(): Promise<Record<string, string>> {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) return {}
      return { Authorization: `Bearer ${session.access_token}` }
    }

    export function usePreferences() {
      const [savedDomains, setSavedDomains] = useState<string[] | null>(null)
      const [loading, setLoading] = useState(true)

      useEffect(() => {
        let cancelled = false
        getAuthHeader().then(async headers => {
          if (!headers.Authorization) { setLoading(false); return }
          try {
            const res = await fetch(`${API_BASE}/api/preferences`, { headers })
            if (!res.ok) throw new Error('fetch failed')
            const data = await res.json()
            if (!cancelled) setSavedDomains(data.domains ?? [])
          } catch {
            if (!cancelled) setSavedDomains([])
          } finally {
            if (!cancelled) setLoading(false)
          }
        })
        return () => { cancelled = true }
      }, [])

      const saveDomains = useCallback(async (domains: string[]) => {
        const headers = await getAuthHeader()
        if (!headers.Authorization) return
        await fetch(`${API_BASE}/api/preferences`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...headers },
          body: JSON.stringify({ domains }),
        })
        setSavedDomains(domains)
      }, [])

      return { savedDomains, loading, saveDomains }
    }
    ```

    Add `VITE_API_URL=http://localhost:8000` to `frontend/.env` if not already present.
  </action>
  <verify>cd /c/claude-projects/investment-project/frontend && npx tsc --noEmit 2>&amp;1 | grep usePreferences || echo "no errors"</verify>
  <done>usePreferences.ts compiles without TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Wire preferences into dashboard</name>
  <files>frontend/src/routes/_authenticated/dashboard.tsx</files>
  <action>
    In `frontend/src/routes/_authenticated/dashboard.tsx`, update the activeDomain initialization and DomainSelector onChange to use usePreferences:

    1. Import the hook: `import { usePreferences } from '../../hooks/usePreferences'`

    2. Add inside the component (after existing useState calls):
       ```tsx
       const { savedDomains, loading: prefLoading, saveDomains } = usePreferences()
       ```

    3. Replace the existing `activeDomain` initialization logic:
       ```tsx
       // OLD: const currentDomain = activeDomain ?? domains[0]?.domain ?? null
       // NEW: initialize from saved preferences once domains are loaded
       const currentDomain = (() => {
         if (activeDomain) return activeDomain
         if (savedDomains && savedDomains.length > 0) {
           const match = domainNames.find(d => d === savedDomains[0])
           return match ?? domainNames[0] ?? null
         }
         return domainNames[0] ?? null
       })()
       ```

    4. Update the DomainSelector `onSelect` handler to also save:
       ```tsx
       onSelect={(domain) => {
         setActiveDomain(domain)
         saveDomains([domain])
       }}
       ```

    5. The "merge on login" behavior (current selection saved on first login) is handled by the initial PUT in usePreferences when savedDomains comes back empty and activeDomain is already set — add this effect:
       ```tsx
       useEffect(() => {
         if (!prefLoading && savedDomains !== null && savedDomains.length === 0 && currentDomain) {
           saveDomains([currentDomain])
         }
       }, [prefLoading, savedDomains])
       ```
  </action>
  <verify>cd /c/claude-projects/investment-project/frontend && npm run build 2>&amp;1 | tail -10</verify>
  <done>Build succeeds; dashboard uses usePreferences for activeDomain initialization and saves on domain change.</done>
</task>

</tasks>

<verification>
- `npm run build` exits 0
- Dashboard code references `usePreferences` and `saveDomains`
- On domain change, PUT /api/preferences is called with Authorization header
</verification>

<success_criteria>
Domain selection auto-saves on change; saved preference restored on next login; new users default to first domain.
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-personalization/04-04-SUMMARY.md`
</output>
