---
phase: 04-authentication-personalization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/supabase.ts
  - frontend/src/routes/__root.tsx
  - frontend/src/routes/index.tsx
  - frontend/src/routes/login.tsx
  - frontend/src/routes/register.tsx
  - frontend/src/routes/_authenticated/route.tsx
  - frontend/src/routes/_authenticated/dashboard.tsx
  - frontend/src/main.tsx
  - frontend/src/App.tsx
  - frontend/package.json
  - frontend/.env
autonomous: true
requirements: [AUTH-01, AUTH-02, AUTH-03]

user_setup:
  - service: supabase
    why: "Frontend Supabase client needs project URL and anon key"
    env_vars:
      - name: VITE_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: VITE_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
    dashboard_config:
      - task: "Disable email confirmation"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email -> uncheck 'Confirm email'"

must_haves:
  truths:
    - "User can navigate to /login and submit email/password to sign in"
    - "User can navigate to /register and submit email/password to create account"
    - "Authenticated user is redirected to /dashboard automatically"
    - "Unauthenticated user attempting /dashboard is redirected to /login"
    - "Session persists across page refresh (localStorage via Supabase client)"
  artifacts:
    - path: "frontend/src/lib/supabase.ts"
      provides: "Supabase client with persistSession: true"
      contains: "createClient"
    - path: "frontend/src/routes/_authenticated/route.tsx"
      provides: "beforeLoad auth guard"
      contains: "beforeLoad"
    - path: "frontend/src/routes/login.tsx"
      provides: "Sign-in form"
      contains: "signInWithPassword"
    - path: "frontend/src/routes/register.tsx"
      provides: "Sign-up form"
      contains: "signUp"
  key_links:
    - from: "frontend/src/routes/_authenticated/route.tsx"
      to: "frontend/src/lib/supabase.ts"
      via: "supabase.auth.getSession()"
      pattern: "getSession"
    - from: "frontend/src/routes/__root.tsx"
      to: "TanStack Router RouterProvider"
      via: "createRootRoute"
      pattern: "createRootRoute"
---

<objective>
Wire TanStack Router into the frontend, create login/register pages, and add an authenticated route guard. Move existing dashboard content into the protected layout.

Purpose: Users must authenticate before accessing ranking data; session persists across refreshes.
Output: Routed SPA with /login, /register, and protected /dashboard.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@frontend/src/App.tsx
@frontend/src/main.tsx
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install deps, create Supabase client, scaffold router</name>
  <files>
    frontend/package.json,
    frontend/src/lib/supabase.ts,
    frontend/src/routes/__root.tsx,
    frontend/src/routes/index.tsx,
    frontend/src/main.tsx
  </files>
  <action>
    Install packages:
    ```bash
    cd frontend && npm install @supabase/supabase-js @tanstack/react-router
    ```

    Create `frontend/src/lib/supabase.ts`:
    ```ts
    import { createClient } from '@supabase/supabase-js'

    export const supabase = createClient(
      import.meta.env.VITE_SUPABASE_URL,
      import.meta.env.VITE_SUPABASE_ANON_KEY,
      { auth: { persistSession: true, autoRefreshToken: true } }
    )
    ```

    Create `frontend/src/routes/__root.tsx`:
    ```tsx
    import { createRootRoute, Outlet } from '@tanstack/react-router'

    export const Route = createRootRoute({
      component: () => <Outlet />,
    })
    ```

    Create `frontend/src/routes/index.tsx` — redirect based on auth state:
    ```tsx
    import { createFileRoute, redirect } from '@tanstack/react-router'
    import { supabase } from '../lib/supabase'

    export const Route = createFileRoute('/')({
      beforeLoad: async () => {
        const { data } = await supabase.auth.getSession()
        if (data.session) {
          throw redirect({ to: '/dashboard' })
        } else {
          throw redirect({ to: '/login' })
        }
      },
      component: () => null,
    })
    ```

    Update `frontend/src/main.tsx` to use TanStack Router. Import and create the router from route tree, wrap `<App />` (or replace it) with `<RouterProvider router={router} />`. Use `createRouter` from `@tanstack/react-router`. The route tree must include all routes in `src/routes/`.

    If TanStack Router file-based routing requires a generated `routeTree.gen.ts`, use manual route tree instead:
    ```ts
    import { createRouter, createRoute } from '@tanstack/react-router'
    // import each Route from its file
    const routeTree = rootRoute.addChildren([indexRoute, loginRoute, registerRoute, authenticatedRoute])
    const router = createRouter({ routeTree })
    ```
  </action>
  <verify>
    ```bash
    cd frontend && npm run build 2>&1 | tail -5
    ```
    Build completes without error.
  </verify>
  <done>Supabase client created; TanStack Router initialized in main.tsx; index route redirects based on session</done>
</task>

<task type="auto">
  <name>Task 2: Login, register pages + authenticated layout with dashboard</name>
  <files>
    frontend/src/routes/login.tsx,
    frontend/src/routes/register.tsx,
    frontend/src/routes/_authenticated/route.tsx,
    frontend/src/routes/_authenticated/dashboard.tsx
  </files>
  <action>
    Create `frontend/src/routes/login.tsx`:
    - Form with email + password inputs and a Submit button
    - On submit: call `supabase.auth.signInWithPassword({ email, password })`
    - On success: `router.navigate({ to: '/dashboard' })`
    - On error: show error message below form
    - Link to /register for new users
    - Tailwind classes for layout (centered card, max-w-sm)

    Create `frontend/src/routes/register.tsx`:
    - Same form structure as login
    - On submit: call `supabase.auth.signUp({ email, password })`
    - On success: navigate to /dashboard (email confirmation disabled per user setup)
    - On error: show error message
    - Link to /login for existing users

    Create `frontend/src/routes/_authenticated/route.tsx` — auth guard:
    ```tsx
    import { createFileRoute, redirect, Outlet } from '@tanstack/react-router'
    import { supabase } from '../../lib/supabase'

    export const Route = createFileRoute('/_authenticated')({
      beforeLoad: async () => {
        const { data } = await supabase.auth.getSession()
        if (!data.session) {
          throw redirect({ to: '/login' })
        }
      },
      component: () => <Outlet />,
    })
    ```

    Create `frontend/src/routes/_authenticated/dashboard.tsx`:
    - Move the existing dashboard content from `App.tsx` into this component
    - Add a sign-out button in the header: calls `supabase.auth.signOut()` then redirects to /login
    - Import existing components (DomainSelector, StockCard, etc.) using the same paths as before
    - Keep all existing TanStack Query polling logic intact

    Update `frontend/src/App.tsx` to be a minimal shell or remove it if main.tsx renders RouterProvider directly.
  </action>
  <verify>
    ```bash
    cd frontend && npm run build 2>&1 | tail -5
    ```
    Build completes without TypeScript errors. Visiting /login in browser shows the sign-in form.
  </verify>
  <done>
    /login shows email+password form; /register shows sign-up form; /_authenticated redirects to /login if no session; /dashboard shows ranking UI with sign-out button
  </done>
</task>

</tasks>

<verification>
```bash
cd frontend && npm run build
```
Zero TypeScript errors. No `any` types introduced unless pre-existing.
</verification>

<success_criteria>
- npm run build succeeds
- /login and /register render without runtime errors
- Submitting valid credentials on /login navigates to /dashboard
- Refreshing /dashboard while logged in does not redirect to /login (session persists)
- Sign-out button on /dashboard calls supabase.auth.signOut() and redirects to /login
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-personalization/04-03-SUMMARY.md`
</output>
