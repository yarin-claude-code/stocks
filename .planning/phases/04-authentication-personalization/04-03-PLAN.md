---
phase: 04-authentication-personalization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/supabase.ts
  - frontend/src/routes/__root.tsx
  - frontend/src/routes/index.tsx
  - frontend/src/routes/login.tsx
  - frontend/src/routes/_authenticated/route.tsx
  - frontend/src/routes/_authenticated/dashboard.tsx
  - frontend/src/App.tsx
  - frontend/src/main.tsx
  - frontend/.env
  - frontend/package.json
autonomous: true
requirements: [AUTH-01, AUTH-02, AUTH-03]

user_setup:
  - service: supabase
    why: "Frontend auth client"
    env_vars:
      - name: VITE_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: VITE_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon public key"

must_haves:
  truths:
    - "Unauthenticated user visiting / is hard-redirected to /login"
    - "Logged-in user visiting /login is redirected to /"
    - "User can register with email + password + display name on /login"
    - "User can log in with email + password on /login"
    - "Session persists across browser tab close (localStorage)"
    - "User display name shown in header after login"
    - "Logout button in header dropdown redirects to /login"
  artifacts:
    - path: "frontend/src/lib/supabase.ts"
      provides: "Supabase client singleton"
    - path: "frontend/src/routes/login.tsx"
      provides: "Login/register toggle page"
    - path: "frontend/src/routes/_authenticated/route.tsx"
      provides: "Protected layout with beforeLoad guard"
    - path: "frontend/src/routes/_authenticated/dashboard.tsx"
      provides: "Existing dashboard content under auth guard"
  key_links:
    - from: "frontend/src/routes/_authenticated/route.tsx"
      to: "frontend/src/lib/supabase.ts"
      via: "supabase.auth.getSession()"
      pattern: "getSession"
    - from: "frontend/src/routes/login.tsx"
      to: "frontend/src/lib/supabase.ts"
      via: "supabase.auth.signUp / signInWithPassword"
      pattern: "signUp|signInWithPassword"
---

<objective>
Install TanStack Router, create Supabase client, build login/register page, and wrap dashboard in an authenticated layout route.

Purpose: Implements the full auth UX — registration, login, session persistence, protected routes, and logout.
Output: Working /login page and protected / route; existing dashboard accessible only when authenticated.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-authentication-personalization/04-CONTEXT.md
@.planning/phases/04-authentication-personalization/04-RESEARCH.md
@frontend/src/App.tsx
@frontend/src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies + Supabase client singleton</name>
  <files>frontend/package.json, frontend/src/lib/supabase.ts, frontend/.env</files>
  <action>
    1. Install packages:
       ```bash
       cd /c/claude-projects/investment-project/frontend
       npm install @supabase/supabase-js @tanstack/react-router
       ```
    2. Create `frontend/src/lib/supabase.ts`:
       ```ts
       import { createClient } from '@supabase/supabase-js'

       export const supabase = createClient(
         import.meta.env.VITE_SUPABASE_URL as string,
         import.meta.env.VITE_SUPABASE_ANON_KEY as string,
         { auth: { persistSession: true, autoRefreshToken: true } }
       )
       ```
    3. Add placeholder vars to `frontend/.env` (gitignored — create if missing):
       ```
       VITE_SUPABASE_URL=https://your-project.supabase.co
       VITE_SUPABASE_ANON_KEY=your-anon-key
       ```
       (User must fill real values.)
  </action>
  <verify>cd /c/claude-projects/investment-project/frontend && node -e "require('./node_modules/@supabase/supabase-js')" && echo ok</verify>
  <done>@supabase/supabase-js and @tanstack/react-router installed in node_modules; supabase.ts exists.</done>
</task>

<task type="auto">
  <name>Task 2: TanStack Router setup + login page + protected layout + move dashboard</name>
  <files>
    frontend/src/main.tsx,
    frontend/src/routes/__root.tsx,
    frontend/src/routes/index.tsx,
    frontend/src/routes/login.tsx,
    frontend/src/routes/_authenticated/route.tsx,
    frontend/src/routes/_authenticated/dashboard.tsx
  </files>
  <action>
    Restructure the frontend to use TanStack Router file-based routing.

    **frontend/src/main.tsx** — replace createRoot call:
    ```tsx
    import { StrictMode } from 'react'
    import { createRoot } from 'react-dom/client'
    import { RouterProvider, createRouter } from '@tanstack/react-router'
    import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
    import { routeTree } from './routeTree.gen'
    import './index.css'

    const queryClient = new QueryClient()
    const router = createRouter({ routeTree })

    createRoot(document.getElementById('root')!).render(
      <StrictMode>
        <QueryClientProvider client={queryClient}>
          <RouterProvider router={router} />
        </QueryClientProvider>
      </StrictMode>
    )
    ```

    NOTE: TanStack Router v1 with file-based routing requires `@tanstack/router-vite-plugin` for auto-generating `routeTree.gen.ts`. Add it:
    ```bash
    npm install -D @tanstack/router-vite-plugin
    ```
    Update `frontend/vite.config.ts` to add the plugin:
    ```ts
    import { TanStackRouterVite } from '@tanstack/router-vite-plugin'
    // add to plugins array: TanStackRouterVite()
    ```

    **frontend/src/routes/__root.tsx**:
    ```tsx
    import { createRootRoute, Outlet } from '@tanstack/react-router'

    export const Route = createRootRoute({
      component: () => <Outlet />,
    })
    ```

    **frontend/src/routes/index.tsx** (redirect root to dashboard or login):
    ```tsx
    import { createFileRoute, redirect } from '@tanstack/react-router'
    import { supabase } from '../lib/supabase'

    export const Route = createFileRoute('/')({
      beforeLoad: async () => {
        const { data: { session } } = await supabase.auth.getSession()
        if (session) {
          throw redirect({ to: '/_authenticated/dashboard' })
        } else {
          throw redirect({ to: '/login' })
        }
      },
      component: () => null,
    })
    ```

    **frontend/src/routes/login.tsx** — Single page with email/password/display-name form; tab toggle between Login and Register modes:
    ```tsx
    import { useState } from 'react'
    import { createFileRoute, useNavigate } from '@tanstack/react-router'
    import { supabase } from '../lib/supabase'

    export const Route = createFileRoute('/login')({
      beforeLoad: async () => {
        const { data: { session } } = await supabase.auth.getSession()
        if (session) throw redirect({ to: '/_authenticated/dashboard' })
      },
      component: LoginPage,
    })

    function LoginPage() {
      const navigate = useNavigate()
      const [mode, setMode] = useState<'login' | 'register'>('login')
      const [email, setEmail] = useState('')
      const [password, setPassword] = useState('')
      const [displayName, setDisplayName] = useState('')
      const [error, setError] = useState<string | null>(null)
      const [loading, setLoading] = useState(false)

      async function handleSubmit(e: React.FormEvent) {
        e.preventDefault()
        setError(null)
        setLoading(true)
        try {
          if (mode === 'register') {
            const { error } = await supabase.auth.signUp({
              email,
              password,
              options: { data: { display_name: displayName } },
            })
            if (error) throw error
          } else {
            const { error } = await supabase.auth.signInWithPassword({ email, password })
            if (error) throw error
          }
          navigate({ to: '/_authenticated/dashboard' })
        } catch (err: any) {
          setError(err.message ?? 'An error occurred')
        } finally {
          setLoading(false)
        }
      }

      return (
        <div className="min-h-screen bg-slate-950 flex items-center justify-center">
          <div className="w-full max-w-sm bg-slate-900 border border-slate-800 rounded-xl p-8">
            <h1 className="text-xl font-bold text-white mb-6">Smart Stock Ranker</h1>
            <div className="flex gap-2 mb-6">
              <button
                className={`flex-1 py-1.5 rounded text-sm font-medium transition-colors ${mode === 'login' ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400'}`}
                onClick={() => setMode('login')}
              >Login</button>
              <button
                className={`flex-1 py-1.5 rounded text-sm font-medium transition-colors ${mode === 'register' ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400'}`}
                onClick={() => setMode('register')}
              >Register</button>
            </div>
            <form onSubmit={handleSubmit} className="flex flex-col gap-4">
              {mode === 'register' && (
                <div>
                  <input
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white text-sm placeholder:text-slate-500"
                    placeholder="Display name"
                    value={displayName}
                    onChange={e => setDisplayName(e.target.value)}
                    required
                  />
                </div>
              )}
              <input
                className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white text-sm placeholder:text-slate-500"
                type="email"
                placeholder="Email"
                value={email}
                onChange={e => setEmail(e.target.value)}
                required
              />
              <div>
                <input
                  className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white text-sm placeholder:text-slate-500"
                  type="password"
                  placeholder="Password"
                  value={password}
                  onChange={e => setPassword(e.target.value)}
                  required
                />
                {error && <p className="text-red-400 text-xs mt-1">{error}</p>}
              </div>
              <button
                type="submit"
                disabled={loading}
                className="w-full bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 text-white font-medium py-2 rounded text-sm transition-colors"
              >
                {loading ? 'Loading…' : mode === 'login' ? 'Sign in' : 'Create account'}
              </button>
            </form>
          </div>
        </div>
      )
    }
    ```

    **frontend/src/routes/_authenticated/route.tsx** — layout with beforeLoad guard + logout in header:
    ```tsx
    import { createFileRoute, Outlet, redirect, useNavigate } from '@tanstack/react-router'
    import { supabase } from '../../lib/supabase'

    export const Route = createFileRoute('/_authenticated')({
      beforeLoad: async () => {
        const { data: { session } } = await supabase.auth.getSession()
        if (!session) throw redirect({ to: '/login' })
      },
      component: AuthenticatedLayout,
    })

    function AuthenticatedLayout() {
      // exposes session via context for child routes if needed
      return <Outlet />
    }
    ```

    **frontend/src/routes/_authenticated/dashboard.tsx** — move ALL existing App.tsx content here; add user display name + logout to header:
    - Copy the full JSX from `frontend/src/App.tsx` into the component function
    - Replace the header right-side `div` to include:
      ```tsx
      // Get session for display name
      const [session, setSession] = useState<any>(null)
      useEffect(() => {
        supabase.auth.getSession().then(({ data }) => setSession(data.session))
      }, [])
      const displayName = session?.user?.user_metadata?.display_name ?? session?.user?.email ?? ''
      ```
    - Add user chip + dropdown in header (right of market status):
      ```tsx
      <div className="relative group">
        <button className="text-xs bg-slate-800 border border-slate-700 text-slate-300 px-3 py-1 rounded-full">
          {displayName}
        </button>
        <div className="absolute right-0 mt-1 hidden group-hover:block bg-slate-900 border border-slate-800 rounded shadow-lg">
          <button
            className="block w-full text-left px-4 py-2 text-sm text-slate-300 hover:text-white hover:bg-slate-800"
            onClick={async () => {
              await supabase.auth.signOut()
              window.location.href = '/login'
            }}
          >
            Logout
          </button>
        </div>
      </div>
      ```
    - Create the route export:
      ```tsx
      export const Route = createFileRoute('/_authenticated/dashboard')({
        component: Dashboard,
      })
      ```

    After creating all route files, run `npm run dev` briefly to trigger routeTree.gen.ts generation (the vite plugin creates it on first build/dev). If auto-gen is not available, create `frontend/src/routeTree.gen.ts` manually with the correct route tree structure for the 4 routes above.
  </action>
  <verify>cd /c/claude-projects/investment-project/frontend && npm run build 2>&amp;1 | tail -20</verify>
  <done>Build succeeds without TypeScript errors; routeTree.gen.ts exists; all route files exist.</done>
</task>

</tasks>

<verification>
- `npm run build` exits 0
- `frontend/src/routes/login.tsx` exists with signUp and signInWithPassword calls
- `frontend/src/routes/_authenticated/route.tsx` has beforeLoad with getSession check
- `frontend/src/routes/_authenticated/dashboard.tsx` contains the dashboard JSX and logout button
</verification>

<success_criteria>
App builds; visiting / redirects based on auth state; /login renders login/register form; protected layout guards dashboard.
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-personalization/04-03-SUMMARY.md`
</output>
