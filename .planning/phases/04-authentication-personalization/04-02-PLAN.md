---
phase: 04-authentication-personalization
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - backend/app/routers/preferences.py
  - backend/app/main.py
autonomous: true
requirements: [AUTH-04]

must_haves:
  truths:
    - "GET /api/preferences returns current saved domains for the authenticated user"
    - "PUT /api/preferences saves a new list of domain names"
    - "Unauthenticated requests to /api/preferences return 401"
    - "First-time users get an empty domains list (200, not 404)"
  artifacts:
    - path: "backend/app/routers/preferences.py"
      provides: "GET + PUT /api/preferences endpoints"
  key_links:
    - from: "backend/app/routers/preferences.py"
      to: "backend/app/routers/auth.py"
      via: "Depends(get_current_user)"
      pattern: "Depends\\(get_current_user\\)"
    - from: "backend/app/routers/preferences.py"
      to: "backend/app/models/user_preference.py"
      via: "SQLAlchemy async session"
      pattern: "UserPreference"
---

<objective>
Implement GET and PUT /api/preferences endpoints protected by the JWT dependency.

Purpose: Allows the frontend to read and write the user's saved domain list.
Output: Two authenticated REST endpoints wired into FastAPI.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-authentication-personalization/04-RESEARCH.md
@backend/app/routers/rankings.py
@backend/app/models/user_preference.py
@backend/app/routers/auth.py
@backend/app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: GET + PUT /api/preferences router</name>
  <files>backend/app/routers/preferences.py</files>
  <action>
    Create `backend/app/routers/preferences.py`:

    ```python
    from fastapi import APIRouter, Depends
    from pydantic import BaseModel
    from sqlalchemy import select
    from sqlalchemy.ext.asyncio import AsyncSession
    import uuid

    from app.database import get_db
    from app.models.user_preference import UserPreference
    from app.routers.auth import get_current_user

    router = APIRouter(prefix="/api/preferences", tags=["preferences"])

    class PreferencesOut(BaseModel):
        domains: list[str]

    class PreferencesIn(BaseModel):
        domains: list[str]

    @router.get("", response_model=PreferencesOut)
    async def get_preferences(
        user_id: str = Depends(get_current_user),
        db: AsyncSession = Depends(get_db),
    ):
        result = await db.execute(
            select(UserPreference).where(UserPreference.user_id == uuid.UUID(user_id))
        )
        pref = result.scalar_one_or_none()
        return PreferencesOut(domains=pref.domains if pref else [])

    @router.put("", response_model=PreferencesOut)
    async def put_preferences(
        body: PreferencesIn,
        user_id: str = Depends(get_current_user),
        db: AsyncSession = Depends(get_db),
    ):
        uid = uuid.UUID(user_id)
        result = await db.execute(
            select(UserPreference).where(UserPreference.user_id == uid)
        )
        pref = result.scalar_one_or_none()
        if pref is None:
            pref = UserPreference(user_id=uid, domains=body.domains)
            db.add(pref)
        else:
            pref.domains = body.domains
        await db.commit()
        return PreferencesOut(domains=pref.domains)
    ```
  </action>
  <verify>cd /c/claude-projects/investment-project/backend && python -c "from app.routers.preferences import router; print('ok')"</verify>
  <done>Router imports without error; endpoints registered at GET /api/preferences and PUT /api/preferences.</done>
</task>

<task type="auto">
  <name>Task 2: Register preferences router in main.py</name>
  <files>backend/app/main.py</files>
  <action>
    In `backend/app/main.py`:
    1. Add import: `from .routers.preferences import router as preferences_router`
    2. Add: `app.include_router(preferences_router)`
    3. Update `allow_methods` in CORSMiddleware to `["GET", "PUT"]`.
  </action>
  <verify>cd /c/claude-projects/investment-project/backend && uvicorn app.main:app --host 0.0.0.0 --port 8000 &amp; sleep 3 &amp;&amp; curl -s http://localhost:8000/api/preferences | head -c 100; kill %1 2>/dev/null</verify>
  <done>GET /api/preferences returns 422 (missing Authorization header) â€” proves route is registered and auth dependency fires.</done>
</task>

</tasks>

<verification>
- `curl -s http://localhost:8000/api/preferences` returns 422 (no auth header)
- `curl -s -H "Authorization: Bearer invalid" http://localhost:8000/api/preferences` returns 401
- Server starts without import errors
</verification>

<success_criteria>
/api/preferences routes live; unauthenticated requests rejected with 401/422; authenticated requests read/write user_preferences table.
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-personalization/04-02-SUMMARY.md`
</output>
