---
phase: 04-authentication-personalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/config.py
  - backend/app/main.py
  - backend/alembic/versions/0002_user_preferences.py
autonomous: true
requirements: [AUTH-01, AUTH-02, AUTH-03]

must_haves:
  truths:
    - "JWT tokens signed by Supabase are verified by the backend"
    - "user_preferences table exists with RLS policies"
    - "CORS allows Authorization header and PUT method"
  artifacts:
    - path: "backend/app/config.py"
      provides: "supabase_url, supabase_anon_key, supabase_jwt_secret settings"
      contains: "supabase_jwt_secret"
    - path: "backend/alembic/versions/0002_user_preferences.py"
      provides: "user_preferences table + RLS policies"
      contains: "op.execute"
  key_links:
    - from: "backend/app/routers/auth.py"
      to: "settings.supabase_jwt_secret"
      via: "jwt.decode(..., settings.supabase_jwt_secret)"
      pattern: "supabase_jwt_secret"
    - from: "backend/alembic/versions/0002_user_preferences.py"
      to: "auth.users"
      via: "REFERENCES auth.users(id)"
      pattern: "auth\\.users"
---

<objective>
Add backend auth foundation: config vars, JWT verification dependency, Alembic migration for user_preferences, and CORS update.

Purpose: Unblock preferences router and protected frontend routes.
Output: Working `get_current_user` FastAPI dependency + migrated user_preferences table.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/config.py
@backend/app/main.py
@backend/alembic/versions/81cb55ab1baf_initial_schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config + add get_current_user dependency</name>
  <files>backend/app/config.py, backend/app/routers/auth.py</files>
  <action>
    In `backend/app/config.py`, add three new fields to the `Settings` class:
    ```python
    supabase_url: str
    supabase_anon_key: str
    supabase_jwt_secret: str
    ```

    Create `backend/app/routers/auth.py` with a single FastAPI dependency:
    ```python
    import jwt
    from fastapi import Header, HTTPException

    def get_current_user(authorization: str = Header(...)) -> str:
        try:
            token = authorization.removeprefix("Bearer ")
            payload = jwt.decode(
                token,
                settings.supabase_jwt_secret,
                algorithms=["HS256"],
                audience="authenticated",
            )
            return payload["sub"]  # user UUID string
        except jwt.PyJWTError:
            raise HTTPException(status_code=401, detail="Invalid token")
    ```

    Import `settings` from `app.config`. Do NOT register a router — this file only exports the dependency.

    Add `PyJWT>=2.8.0` to `backend/requirements.txt` if not already present.
  </action>
  <verify>
    ```bash
    cd backend && python -c "from app.routers.auth import get_current_user; print('ok')"
    ```
    Should print `ok` with no import errors.
  </verify>
  <done>get_current_user importable; Settings has supabase_jwt_secret field</done>
</task>

<task type="auto">
  <name>Task 2: Alembic migration for user_preferences + CORS update</name>
  <files>backend/alembic/versions/0002_user_preferences.py, backend/app/main.py</files>
  <action>
    Create `backend/alembic/versions/0002_user_preferences.py`. Set `down_revision` to `'81cb55ab1baf'` (the initial schema revision). Use `op.execute()` for all DDL — do NOT use autogenerate or `op.create_table()` because cross-schema FK to `auth.users` is not tracked by Alembic autogenerate.

    ```python
    def upgrade() -> None:
        op.execute("""
            CREATE TABLE user_preferences (
                id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
                user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
                domains text[] NOT NULL DEFAULT '{}',
                updated_at timestamptz NOT NULL DEFAULT now()
            );
            ALTER TABLE user_preferences ENABLE ROW LEVEL SECURITY;
            CREATE POLICY "own_select" ON user_preferences
                FOR SELECT TO authenticated USING (auth.uid() = user_id);
            CREATE POLICY "own_insert" ON user_preferences
                FOR INSERT TO authenticated WITH CHECK (auth.uid() = user_id);
            CREATE POLICY "own_update" ON user_preferences
                FOR UPDATE TO authenticated
                USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
        """)

    def downgrade() -> None:
        op.execute("DROP TABLE IF EXISTS user_preferences;")
    ```

    In `backend/app/main.py`, update the `CORSMiddleware` configuration:
    - Add `"PUT"` to `allow_methods`
    - Add `"Authorization"` to `allow_headers`
    Keep existing origins and other settings unchanged.
  </action>
  <verify>
    ```bash
    cd backend && alembic upgrade head
    ```
    Migration runs without error. Confirm in Supabase dashboard that `user_preferences` table exists with RLS enabled.
  </verify>
  <done>user_preferences table exists with 3 RLS policies; CORS allows PUT + Authorization header</done>
</task>

</tasks>

<verification>
```bash
cd backend && python -c "from app.routers.auth import get_current_user; from app.config import settings; print(settings.supabase_jwt_secret[:4])"
cd backend && alembic current
```
</verification>

<success_criteria>
- Settings loads supabase_jwt_secret from .env without error
- get_current_user dependency importable and raises 401 on bad token
- user_preferences table present in Supabase with RLS enabled
- CORS middleware allows PUT and Authorization header
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-personalization/04-01-SUMMARY.md`
</output>
