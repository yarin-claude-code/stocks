---
phase: 04-authentication-personalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/config.py
  - backend/app/models/user_preference.py
  - backend/app/routers/auth.py
  - backend/app/main.py
  - backend/alembic/versions/user_preferences_migration.py
  - backend/.env
autonomous: true
requirements: [AUTH-01, AUTH-02]

user_setup:
  - service: supabase
    why: "JWT verification + user_preferences table"
    env_vars:
      - name: SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon public key"
      - name: SUPABASE_JWT_SECRET
        source: "Supabase Dashboard -> Settings -> API -> JWT Secret"
    dashboard_config:
      - task: "Disable email confirmation"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email -> Confirm email: OFF"

must_haves:
  truths:
    - "A valid Supabase JWT is accepted and returns the user UUID"
    - "An invalid or missing JWT returns 401"
    - "user_preferences table exists in Supabase Postgres with RLS enabled"
    - "CORS allows Authorization header from localhost:5173"
  artifacts:
    - path: "backend/app/config.py"
      provides: "supabase_url, supabase_anon_key, supabase_jwt_secret settings"
    - path: "backend/app/routers/auth.py"
      provides: "get_current_user FastAPI dependency"
    - path: "backend/app/models/user_preference.py"
      provides: "UserPreference SQLAlchemy model"
    - path: "backend/alembic/versions/user_preferences_migration.py"
      provides: "user_preferences table + RLS migration"
  key_links:
    - from: "backend/app/routers/auth.py"
      to: "backend/app/config.py"
      via: "settings.supabase_jwt_secret"
      pattern: "jwt\\.decode.*supabase_jwt_secret"
    - from: "backend/alembic/versions/user_preferences_migration.py"
      to: "auth.users"
      via: "raw SQL FK"
      pattern: "REFERENCES auth\\.users"
---

<objective>
Add Supabase JWT verification to the backend and create the user_preferences table.

Purpose: Provides the auth dependency all protected routes will use, and the DB table for preference storage.
Output: Working `get_current_user` dependency + migrated user_preferences table with RLS.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-authentication-personalization/04-RESEARCH.md
@backend/app/config.py
@backend/app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Settings + add get_current_user dependency</name>
  <files>backend/app/config.py, backend/app/routers/auth.py, backend/requirements.txt</files>
  <action>
    1. In `backend/app/config.py`, add three fields to `Settings`:
       ```python
       supabase_url: str
       supabase_anon_key: str
       supabase_jwt_secret: str
       ```
    2. Create `backend/app/routers/auth.py`:
       ```python
       import jwt
       from fastapi import Header, HTTPException

       from app.config import settings

       def get_current_user(authorization: str = Header(...)) -> str:
           if not authorization.startswith("Bearer "):
               raise HTTPException(status_code=401, detail="Missing bearer token")
           token = authorization.split(" ", 1)[1]
           try:
               payload = jwt.decode(
                   token,
                   settings.supabase_jwt_secret,
                   algorithms=["HS256"],
                   audience="authenticated",
               )
           except jwt.PyJWTError:
               raise HTTPException(status_code=401, detail="Invalid token")
           return payload["sub"]
       ```
    3. Add `PyJWT==2.8.0` to `backend/requirements.txt`.
    4. Add SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_JWT_SECRET to `backend/.env` (user must fill values — add as placeholder lines with comments).
    5. In `backend/app/main.py`, update CORS `allow_methods` to include "PUT" and add `allow_headers=["*"]` already present — confirm `Authorization` is covered (it is with `*`). Also add "PUT" to allowed methods since preferences router needs it.
  </action>
  <verify>cd /c/claude-projects/investment-project/backend && python -c "from app.routers.auth import get_current_user; print('ok')"</verify>
  <done>Import succeeds; Settings loads the three new supabase_ fields without error when .env has them.</done>
</task>

<task type="auto">
  <name>Task 2: UserPreference model + Alembic migration with RLS</name>
  <files>backend/app/models/user_preference.py, backend/alembic/versions/user_preferences_migration.py</files>
  <action>
    1. Create `backend/app/models/user_preference.py`:
       ```python
       from sqlalchemy.orm import Mapped, mapped_column
       from sqlalchemy import String, ARRAY, DateTime, func
       import uuid
       from app.database import Base

       class UserPreference(Base):
           __tablename__ = "user_preferences"
           id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
           user_id: Mapped[uuid.UUID] = mapped_column(nullable=False, unique=True)
           domains: Mapped[list[str]] = mapped_column(ARRAY(String), nullable=False, default=list)
           updated_at: Mapped[datetime] = mapped_column(
               DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False
           )
       ```
       (import `datetime` from stdlib)

    2. Create Alembic migration. Run `alembic revision --autogenerate -m "add_user_preferences"` to get a revision file, then REPLACE its upgrade/downgrade with raw SQL to handle auth.users FK and RLS:
       ```python
       def upgrade() -> None:
           op.execute("""
               CREATE TABLE IF NOT EXISTS user_preferences (
                 id          uuid PRIMARY KEY DEFAULT gen_random_uuid(),
                 user_id     uuid NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
                 domains     text[] NOT NULL DEFAULT '{}',
                 updated_at  timestamptz NOT NULL DEFAULT now()
               );
               ALTER TABLE user_preferences ENABLE ROW LEVEL SECURITY;
               CREATE POLICY "Users manage own preferences" ON user_preferences
                 USING (auth.uid() = user_id)
                 WITH CHECK (auth.uid() = user_id);
           """)

       def downgrade() -> None:
           op.execute("DROP TABLE IF EXISTS user_preferences;")
       ```
    3. Run `alembic upgrade head` to apply the migration.
  </action>
  <verify>cd /c/claude-projects/investment-project/backend && alembic upgrade head && python -c "from app.models.user_preference import UserPreference; print('ok')"</verify>
  <done>Migration applies without error; user_preferences table exists in Supabase with RLS enabled.</done>
</task>

</tasks>

<verification>
- `python -c "from app.routers.auth import get_current_user"` succeeds
- `alembic upgrade head` runs without error
- Supabase table inspector shows user_preferences with RLS policies
</verification>

<success_criteria>
JWT dependency importable; user_preferences table migrated with FK to auth.users and RLS policy.
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-personalization/04-01-SUMMARY.md`
</output>
