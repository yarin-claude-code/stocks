---
phase: 01.1-sqlite-to-supabase-postgres-migration
plan: 01
subsystem: database
tags: [postgres, supabase, asyncpg, psycopg2, alembic, sqlalchemy]

requires:
  - phase: 01-data-pipeline-foundation
    provides: SQLAlchemy models (Stock, Domain, ScoreSnapshot), Alembic setup, FastAPI app with scheduler

provides:
  - asyncpg async engine connected to Supabase Postgres
  - psycopg2-binary sync engine for APScheduler thread (via settings.sync_database_url)
  - Alembic migration applied — tables stocks, domains, score_snapshots in Supabase public schema
  - WAL PRAGMA listener removed, no SQLite dependencies remain

affects:
  - Phase 2 (Ranking Algorithm) — depends on Postgres-backed DB layer
  - Any future phase adding models (uses same Alembic/Supabase setup)

tech-stack:
  added:
    - asyncpg>=0.29 (async Postgres driver replacing aiosqlite)
    - psycopg2-binary>=2.9 (sync Postgres driver for APScheduler thread)
  patterns:
    - sync_database_url property on Settings: replaces postgresql+asyncpg with postgresql+psycopg2 for sync contexts
    - env.py injects DATABASE_URL into Alembic config via config.set_main_option (avoids configparser interpolation issues)
    - .env never committed; .env.example committed as template

key-files:
  created:
    - backend/.env (not committed — real Supabase credentials)
  modified:
    - backend/requirements.txt
    - backend/app/config.py
    - backend/app/database.py
    - backend/app/scheduler.py
    - backend/.env.example
    - backend/alembic.ini
    - backend/alembic/env.py

key-decisions:
  - "sync_database_url property on Settings replaces literal string manipulation in scheduler.py"
  - "Alembic URL set via config.set_main_option in env.py rather than %(VAR)s configparser interpolation"
  - "Direct connection port 5432 (not pgbouncer 6543) for SQLAlchemy session-mode compatibility"
  - "Existing initial_schema migration reused — applied to Supabase without regeneration"

patterns-established:
  - "env.py pattern: load_dotenv() before app imports, then config.set_main_option for URL injection"
  - "Two-engine pattern: async engine (asyncpg) for FastAPI, sync engine (psycopg2) for scheduler thread"

requirements-completed: [DATA-02]

duration: 35min
completed: 2026-02-18
---

# Phase 01.1 Plan 01: SQLite to Supabase Postgres Migration Summary

**asyncpg + psycopg2-binary wired to Supabase, WAL PRAGMA removed, Alembic schema applied — backend fully off SQLite**

## Performance

- **Duration:** ~35 min (including auth gate pause for password correction)
- **Started:** 2026-02-18T16:00:00Z
- **Completed:** 2026-02-18T16:10:00Z
- **Tasks:** 3
- **Files modified:** 7

## Accomplishments

- Replaced aiosqlite with asyncpg for all async DB operations; psycopg2-binary for APScheduler sync thread
- Removed SQLite WAL PRAGMA event listener that would have caused ProgrammingError on Postgres
- Applied existing Alembic migration to Supabase — tables stocks, domains, score_snapshots confirmed in public schema
- Server starts cleanly (no SQLite/PRAGMA errors), health endpoint returns HTTP 200 `{"status": "ok"}`

## Task Commits

Each task was committed atomically:

1. **Task 1: Swap drivers and update config, database, scheduler** - `763dc7f` (feat)
2. **Task 2: Update Alembic config and run initial Postgres migration** - `39ad887` (feat)
3. **Task 3: Smoke test the running server** - `0a93914` (chore)

## Files Created/Modified

- `backend/requirements.txt` - Removed aiosqlite, added asyncpg>=0.29 and psycopg2-binary>=2.9
- `backend/app/config.py` - Removed SQLite default, added sync_database_url property
- `backend/app/database.py` - Removed SQLite WAL PRAGMA event listener and `event` import
- `backend/app/scheduler.py` - Replaced literal string URL manipulation with settings.sync_database_url
- `backend/.env.example` - Updated template to Supabase postgres URL format
- `backend/alembic.ini` - Placeholder URL (overridden in env.py)
- `backend/alembic/env.py` - Added load_dotenv() and config.set_main_option for DATABASE_URL injection

## Decisions Made

- `sync_database_url` as a property on `Settings` keeps the URL derivation in one place rather than scattered across modules
- Alembic URL injected programmatically via `config.set_main_option` because configparser `%(VAR)s` interpolation requires the variable to be defined in the same INI section — environment variables cannot be used that way
- Port 5432 (direct Postgres) used instead of 6543 (pgbouncer) per Supabase recommendation for SQLAlchemy session mode

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Alembic configparser interpolation failure**
- **Found during:** Task 2 (run alembic upgrade head)
- **Issue:** Plan specified `sqlalchemy.url = %(DATABASE_URL)s` in alembic.ini but configparser `%(VAR)s` interpolation only resolves variables defined in the same INI section — not environment variables. This caused `InterpolationMissingOptionError` on every alembic invocation.
- **Fix:** Reverted alembic.ini to a static placeholder URL. In env.py, after `load_dotenv()`, used `config.set_main_option("sqlalchemy.url", os.environ["DATABASE_URL"])` to inject the real URL programmatically before Alembic reads it.
- **Files modified:** backend/alembic.ini, backend/alembic/env.py
- **Verification:** `alembic upgrade head` completed successfully, tables confirmed in Supabase
- **Committed in:** 39ad887 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 - Bug)
**Impact on plan:** Necessary correctness fix. The configparser interpolation approach in the plan would never work for environment variables. No scope creep.

## Issues Encountered

- **Auth gate (Task 2):** Initial .env had wrong Supabase password (`Yarind250!` vs `YarinD250!!`). Execution paused for user to correct the credential. Migration proceeded successfully after correction.

## Next Phase Readiness

- Postgres DB layer fully operational on Supabase — Phase 2 (Ranking Algorithm) can proceed
- All three tables (stocks, domains, score_snapshots) exist with correct schema
- Scheduler and async engine both connect cleanly
- No SQLite code remains — confirmed by grep scan (aiosqlite, PRAGMA, check_same_thread: 0 matches)

---
*Phase: 01.1-sqlite-to-supabase-postgres-migration*
*Completed: 2026-02-18*
