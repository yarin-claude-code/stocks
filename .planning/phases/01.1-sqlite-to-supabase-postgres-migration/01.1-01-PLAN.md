---
phase: 01.1-sqlite-to-supabase-postgres-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/requirements.txt
  - backend/app/config.py
  - backend/app/database.py
  - backend/app/scheduler.py
  - backend/alembic.ini
  - backend/alembic/env.py
  - backend/.env
  - backend/.env.example
autonomous: true
requirements:
  - DATA-02

must_haves:
  truths:
    - "App imports succeed with no SQLite-related errors"
    - "Uvicorn starts, seeds DB, and scheduler runs against Supabase Postgres"
    - "Health endpoint returns 200 with status ok"
    - "Alembic migration applies the schema to Supabase without error"
    - "No SQLite PRAGMA statements are sent to Postgres"
  artifacts:
    - path: "backend/app/config.py"
      provides: "sync_database_url property derived from DATABASE_URL"
      contains: "sync_database_url"
    - path: "backend/app/database.py"
      provides: "Async engine without WAL listener"
      contains: "create_async_engine"
    - path: "backend/app/scheduler.py"
      provides: "Sync engine using psycopg2 via settings.sync_database_url"
      contains: "settings.sync_database_url"
    - path: "backend/requirements.txt"
      provides: "asyncpg and psycopg2-binary, no aiosqlite"
      contains: "asyncpg"
    - path: "backend/alembic.ini"
      provides: "DATABASE_URL interpolation token"
      contains: "%(DATABASE_URL)s"
    - path: "backend/alembic/env.py"
      provides: "dotenv loaded before Alembic reads config"
      contains: "load_dotenv"
    - path: "backend/.env"
      provides: "Real Supabase credentials (not committed)"
      contains: "postgresql+asyncpg"
    - path: "backend/.env.example"
      provides: "Placeholder template for Supabase URL"
      contains: "PROJECT_REF"
  key_links:
    - from: "backend/app/config.py"
      to: "backend/app/scheduler.py"
      via: "settings.sync_database_url property"
      pattern: "sync_database_url"
    - from: "backend/alembic/env.py"
      to: "backend/.env"
      via: "load_dotenv() before config.get_main_option"
      pattern: "load_dotenv"
    - from: "backend/app/database.py"
      to: "asyncpg"
      via: "postgresql+asyncpg:// URL in create_async_engine"
      pattern: "postgresql\\+asyncpg"
---

<objective>
Migrate every SQLite-specific concern in the backend to Supabase Postgres.

Purpose: Phase 2 (Ranking Algorithm) and beyond depend on a Postgres-backed DB layer. This migration eliminates the SQLite driver, WAL mode PRAGMA, and SQLite-specific connection args — replacing them with asyncpg (async) and psycopg2-binary (sync scheduler).

Output: A running FastAPI app connected to Supabase, with schema applied via Alembic migration.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/config.py
@backend/app/database.py
@backend/app/scheduler.py
@backend/requirements.txt
@backend/alembic.ini
@backend/alembic/env.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Swap drivers and update config, database, scheduler</name>
  <files>
    backend/requirements.txt
    backend/app/config.py
    backend/app/database.py
    backend/app/scheduler.py
    backend/.env
    backend/.env.example
  </files>
  <action>
    **backend/requirements.txt** — remove `aiosqlite>=0.20`, add two new lines:
    ```
    asyncpg>=0.29
    psycopg2-binary>=2.9
    ```

    **backend/app/config.py** — remove the default `= "sqlite+aiosqlite:///./stocks.db"` from `database_url` (field becomes required, must be in .env), and add a `sync_database_url` computed property:
    ```python
    from pydantic_settings import BaseSettings

    class Settings(BaseSettings):
        database_url: str
        fetch_interval_minutes: int = 5

        @property
        def sync_database_url(self) -> str:
            return self.database_url.replace("postgresql+asyncpg", "postgresql+psycopg2")

        class Config:
            env_file = ".env"

    settings = Settings()
    ```

    **backend/app/database.py** — delete the `from sqlalchemy import event, select` import line, replace with `from sqlalchemy import select`. Delete the entire WAL listener block (the `@event.listens_for` decorator and `set_wal_mode` function). The WAL listener causes a ProgrammingError ("PRAGMA journal_mode=WAL" is invalid Postgres SQL). Final file:
    ```python
    from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
    from sqlalchemy.orm import DeclarativeBase
    from sqlalchemy import select
    from .config import settings

    engine = create_async_engine(settings.database_url, echo=False)
    async_session_maker = async_sessionmaker(engine, expire_on_commit=False)

    class Base(DeclarativeBase):
        pass

    async def get_db() -> AsyncSession:
        async with async_session_maker() as session:
            yield session

    async def seed_db():
        # ... keep existing seed_db body unchanged
    ```

    **backend/app/scheduler.py** — remove lines:
    ```python
    _sync_db_url = settings.database_url.replace("sqlite+aiosqlite", "sqlite")
    _sync_engine = create_engine(_sync_db_url, connect_args={"check_same_thread": False})
    ```
    Replace with:
    ```python
    _sync_engine = create_engine(settings.sync_database_url)
    ```
    CRITICAL: Do NOT keep `connect_args={"check_same_thread": False}` — psycopg2 raises TypeError on that argument.

    **backend/.env** (create, never commit — already in .gitignore):
    ```
    DATABASE_URL=postgresql+asyncpg://postgres:Yarind250!@db.gaianbrkezkpkngebztd.supabase.co:5432/postgres
    FETCH_INTERVAL_MINUTES=5
    ```
    Use port 5432 (direct connection), NOT 6543 (pgbouncer — incompatible with SQLAlchemy session mode).

    **backend/.env.example** (overwrite, DO commit):
    ```
    DATABASE_URL=postgresql+asyncpg://postgres:PASSWORD@db.PROJECT_REF.supabase.co:5432/postgres
    FETCH_INTERVAL_MINUTES=5
    ```
  </action>
  <verify>
    From the `backend/` directory:
    ```bash
    pip install -r requirements.txt
    python -c "from app.main import app; print('imports OK')"
    ```
    Both commands must succeed with no import errors.
  </verify>
  <done>
    `pip install` completes cleanly (asyncpg and psycopg2-binary installed, aiosqlite absent).
    `python -c "from app.main import app"` prints "imports OK" with no traceback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Alembic config and run initial Postgres migration</name>
  <files>
    backend/alembic.ini
    backend/alembic/env.py
  </files>
  <action>
    **backend/alembic.ini** — change the `sqlalchemy.url` line:
    ```ini
    sqlalchemy.url = %(DATABASE_URL)s
    ```
    The `%(DATABASE_URL)s` token is interpolated from the environment variable at runtime. Alembic's configparser resolves `%(VAR)s` from the `[alembic]` section vars, but we need it from env — hence the env.py change below.

    **backend/alembic/env.py** — add dotenv loading near the top, BEFORE the `from app.database import Base` import (so settings are populated when config.py runs). Insert these two lines after the existing `import os` line:
    ```python
    from dotenv import load_dotenv
    load_dotenv()
    ```
    Also, in `run_migrations_online`, Alembic calls `config.get_section(config.config_ini_section, {})` which reads `sqlalchemy.url` from `alembic.ini`. With `%(DATABASE_URL)s` as the value and `load_dotenv()` already called, `os.environ["DATABASE_URL"]` is set and configparser will interpolate it correctly.

    Then run the migration from `backend/` directory:
    ```bash
    alembic revision --autogenerate -m "initial postgres schema"
    alembic upgrade head
    ```
    The `--autogenerate` command introspects `Base.metadata` (which includes Stock, Domain, ScoreSnapshot models) and generates the migration file. `upgrade head` applies it to Supabase.
  </action>
  <verify>
    ```bash
    alembic upgrade head
    ```
    Must complete with no errors. Then verify tables exist in Supabase by running:
    ```bash
    python -c "
    import asyncio
    from app.database import engine
    from sqlalchemy import text
    async def check():
        async with engine.connect() as conn:
            result = await conn.execute(text(\"SELECT tablename FROM pg_tables WHERE schemaname='public'\"))
            print([r[0] for r in result])
    asyncio.run(check())
    "
    ```
    Output must include `stocks`, `domains`, and `score_snapshots`.
  </verify>
  <done>
    `alembic upgrade head` exits 0. Supabase public schema contains the three expected tables.
  </done>
</task>

<task type="auto">
  <name>Task 3: Smoke test the running server</name>
  <files></files>
  <action>
    Start the server from `backend/` directory:
    ```bash
    uvicorn app.main:app --port 8001 --reload
    ```
    Watch startup logs for:
    - "Application startup complete" (no DB connection errors)
    - Seed domains inserted or "already exists" messages (seed_db ran successfully)
    - Scheduler "fetch_cycle: starting data fetch" log (APScheduler fired)

    In a separate terminal, hit the health endpoint:
    ```bash
    curl http://localhost:8001/api/health
    ```

    Expected response: `{"status": "ok", ...}` with HTTP 200.

    If startup fails, check for:
    - `ProgrammingError: syntax error at or near "PRAGMA"` → WAL listener was not removed from database.py
    - `TypeError: connect() got an unexpected keyword argument 'check_same_thread'` → connect_args not removed from scheduler.py
    - `ValidationError: database_url field required` → .env file missing or not in backend/ directory
    - `asyncpg.exceptions.InvalidAuthorizationSpecification` → wrong password or URL in .env
  </action>
  <verify>
    ```bash
    curl -s http://localhost:8001/api/health | python -m json.tool
    ```
    Returns JSON with `"status": "ok"` and HTTP 200.
  </verify>
  <done>
    Server starts without errors. Health endpoint returns 200. Scheduler logs at least one fetch_cycle execution. No SQLite-related errors anywhere in startup logs.
  </done>
</task>

</tasks>

<verification>
Full migration verified when:
1. `python -c "from app.main import app; print('OK')"` succeeds (no import errors)
2. `alembic upgrade head` completes successfully (tables created in Supabase)
3. `uvicorn app.main:app --port 8001` starts with seed_db and scheduler running
4. `curl http://localhost:8001/api/health` returns `{"status": "ok"}` with 200
5. No references to `aiosqlite`, `PRAGMA`, or `check_same_thread` remain in the codebase
</verification>

<success_criteria>
- asyncpg drives all async DB operations (engine URL is `postgresql+asyncpg://`)
- psycopg2-binary drives scheduler sync engine (via `settings.sync_database_url`)
- WAL mode PRAGMA listener is gone from database.py
- Alembic migration applied to Supabase — tables exist in public schema
- App starts and health endpoint returns 200
- .env is not committed (confirmed by `git status` showing it as untracked/ignored)
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-sqlite-to-supabase-postgres-migration/01.1-01-SUMMARY.md` following the summary template.
</output>
