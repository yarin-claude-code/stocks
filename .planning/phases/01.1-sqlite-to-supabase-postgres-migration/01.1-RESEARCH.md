# Phase 01.1: SQLite to Supabase/Postgres Migration - Research

**Researched:** 2026-02-18
**Domain:** SQLAlchemy 2.0 async Postgres (asyncpg), psycopg2, Alembic, Supabase connection pooling
**Confidence:** HIGH

---

## Summary

This phase replaces every SQLite-specific concern in the Phase 1 backend with Postgres equivalents that talk to a hosted Supabase instance. The application already uses the correct high-level patterns (SQLAlchemy 2.0, async engine, Alembic async env.py, APScheduler sync engine) — only the driver packages and connection strings change. No ORM code, model definitions, or session logic need to change.

The single most important Supabase-specific decision is which port to use. For a long-running FastAPI container (not serverless), the **direct connection on port 5432** is the correct choice: SQLAlchemy manages its own connection pool, prepared statements work normally, and there is no pgbouncer/Supavisor conflict to work around. Switching to the transaction-mode pooler (port 6543) requires disabling the asyncpg statement cache and using NullPool, which adds complexity with no benefit for a static server deployment.

The scheduler's sync engine URL is derived mechanically: replace `postgresql+asyncpg` with `postgresql+psycopg2` in the same connection string. No second environment variable is needed; `config.py` can compute both URLs from a single `DATABASE_URL`.

**Primary recommendation:** Use port 5432 direct connection. Store one `DATABASE_URL` in `.env` using the `postgresql+asyncpg://` scheme. Derive the psycopg2 sync URL in `config.py` via string replacement. Keep the existing async Alembic `env.py` as-is — `async_engine_from_config` works identically with asyncpg.

---

## Standard Stack

### Core

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| `asyncpg` | `>=0.29` | Async Postgres driver for SQLAlchemy | SQLAlchemy's recommended async Postgres driver; fastest Python async Postgres driver |
| `psycopg2-binary` | `>=2.9` | Sync Postgres driver for APScheduler engine | Standard sync driver; `-binary` wheel avoids C build dependency |
| `sqlalchemy` | `>=2.0` (already installed) | ORM and engine | No change — already present |
| `alembic` | `>=1.13` (already installed) | Migrations | No change — already present |

### Removed

| Library | Replaced By | Reason |
|---------|-------------|--------|
| `aiosqlite>=0.20` | `asyncpg` | SQLite async driver no longer needed |

### Phase 4 Auth (out of scope now — note only)

| Library | Version | Purpose |
|---------|---------|---------|
| `supabase` | `>=2.0` | Supabase Python client (wraps auth-py, postgrest-py) |
| `supabase-auth` | `>=2.27` | Auth-py (replaces deprecated `gotrue` package as of August 2025) |

**Installation:**
```bash
pip install asyncpg>=0.29 psycopg2-binary>=2.9
pip uninstall aiosqlite
```

Or update `requirements.txt`:
```
asyncpg>=0.29
psycopg2-binary>=2.9
# remove: aiosqlite>=0.20
```

---

## Architecture Patterns

### Connection String Strategy — Single DATABASE_URL

Store the async URL in `.env`. Derive the sync URL programmatically in `config.py`.

```python
# backend/app/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    database_url: str  # postgresql+asyncpg://...
    fetch_interval_minutes: int = 5

    @property
    def sync_database_url(self) -> str:
        """Sync URL for APScheduler's psycopg2 engine."""
        return self.database_url.replace("postgresql+asyncpg", "postgresql+psycopg2")

    class Config:
        env_file = ".env"

settings = Settings()
```

This mirrors exactly what `scheduler.py` already does for SQLite (`replace("sqlite+aiosqlite", "sqlite")`).

### Pattern 1: Async Engine (database.py)

Remove the WAL-mode event listener (Postgres has no WAL PRAGMA). Replace nothing else.

```python
# Source: SQLAlchemy 2.0 docs https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy.orm import DeclarativeBase
from .config import settings

# No event listener needed — Postgres handles concurrency natively
engine = create_async_engine(settings.database_url, echo=False)

async_session_maker = async_sessionmaker(engine, expire_on_commit=False)

class Base(DeclarativeBase):
    pass

async def get_db() -> AsyncSession:
    async with async_session_maker() as session:
        yield session
```

**What changes from current code:**
- Delete the `event.listens_for` WAL block (lines 9-12 of current `database.py`)
- Remove `from sqlalchemy import event` import
- No other changes

### Pattern 2: Sync Engine for Scheduler (scheduler.py)

```python
# Source: SQLAlchemy 2.0 docs https://docs.sqlalchemy.org/en/20/core/engines.html
from sqlalchemy import create_engine

_sync_engine = create_engine(settings.sync_database_url)
# Note: remove connect_args={"check_same_thread": False} — that is SQLite-only
```

**What changes from current code:**
- Change `_sync_db_url` derivation from `.replace("sqlite+aiosqlite", "sqlite")` to use `settings.sync_database_url`
- Remove `connect_args={"check_same_thread": False}` from `create_engine()` call — this is a SQLite-only argument; passing it to psycopg2 raises a `TypeError`

### Pattern 3: Alembic env.py — No Changes Required

The existing `env.py` uses `async_engine_from_config` with `asyncio.run()`. This pattern works identically for `postgresql+asyncpg` as it does for `sqlite+aiosqlite`. Alembic reads the URL from `alembic.ini` (or env override), which must be updated to the asyncpg URL.

**What changes:**
- `alembic.ini`: update `sqlalchemy.url` to `postgresql+asyncpg://...` (or use `%env:DATABASE_URL%` interpolation)
- `env.py`: no code changes needed

### Pattern 4: .env and .env.example

```
# backend/.env (real credentials — not committed)
DATABASE_URL=postgresql+asyncpg://postgres:Yarind250!@db.gaianbrkezkpkngebztd.supabase.co:5432/postgres
FETCH_INTERVAL_MINUTES=5

# backend/.env.example (template — committed)
DATABASE_URL=postgresql+asyncpg://postgres:PASSWORD@db.PROJECT_REF.supabase.co:5432/postgres
FETCH_INTERVAL_MINUTES=5
```

### Anti-Patterns to Avoid

- **Splitting into ASYNC_DATABASE_URL + SYNC_DATABASE_URL:** Redundant. The sync URL is always derivable from the async URL by driver name replacement. Two env vars create drift risk.
- **Using port 6543 (transaction pooler) with asyncpg:** Requires `statement_cache_size=0` in `connect_args` AND `NullPool`. Adds complexity. Not beneficial for a long-running server that manages its own pool.
- **Passing `connect_args={"check_same_thread": False}` to psycopg2:** This is a SQLite-specific arg. psycopg2 will raise `TypeError: connect() got an unexpected keyword argument 'check_same_thread'`.
- **Keeping the WAL event listener:** `PRAGMA journal_mode=WAL` is a SQLite command. Sending it to Postgres will raise `ProgrammingError`.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Async Postgres connection | Custom asyncio socket code | `asyncpg` via SQLAlchemy | asyncpg handles protocol framing, SSL, binary encoding |
| Connection pooling | Manual pool management | SQLAlchemy's built-in pool (default with `create_async_engine`) | Handles checkout timeouts, recycle, overflow |
| Sync URL derivation | Second env var | String replace in `config.py` | Single source of truth, zero drift |
| Prepared statement issues with pooler | Custom statement naming | Use port 5432 direct connection | Eliminates the problem entirely |

---

## Common Pitfalls

### Pitfall 1: `check_same_thread` Left in create_engine Call
**What goes wrong:** `TypeError: connect() got an unexpected keyword argument 'check_same_thread'` at startup.
**Why it happens:** `check_same_thread=False` is a SQLite-specific `connect_args` key carried over from the SQLite engine.
**How to avoid:** Remove `connect_args={"check_same_thread": False}` from the sync `create_engine()` call in `scheduler.py`.
**Warning signs:** Error appears immediately on first scheduler engine creation, not lazily.

### Pitfall 2: WAL PRAGMA Sent to Postgres
**What goes wrong:** `sqlalchemy.exc.ProgrammingError: (asyncpg.exceptions.SyntaxOrAccessError) syntax error at or near "PRAGMA"` on first connection.
**Why it happens:** The `event.listens_for(engine.sync_engine, "connect")` handler fires on every new connection and executes `PRAGMA journal_mode=WAL`, which is invalid Postgres SQL.
**How to avoid:** Delete the entire WAL event listener block from `database.py`.
**Warning signs:** Error fires on the very first `get_db()` call or during `seed_db()`.

### Pitfall 3: asyncpg Prepared Statement Errors (if port 6543 is ever used)
**What goes wrong:** `asyncpg.exceptions.InvalidSQLStatementNameError: prepared statement "asyncpg_stmt_X" does not exist` under concurrent load.
**Why it happens:** Supabase's transaction-mode pooler (port 6543) does not support prepared statements. asyncpg uses them by default.
**How to avoid:** Use port 5432 (direct connection). If transaction pooler is ever needed, add `connect_args={"statement_cache_size": 0}` and `poolclass=NullPool`.
**Warning signs:** Errors appear only under concurrent load, not in single-request testing.

### Pitfall 4: Alembic URL Not Updated
**What goes wrong:** Migrations run against the old SQLite file instead of Postgres, or fail with driver-not-found error.
**Why it happens:** `alembic.ini` still contains `sqlite+aiosqlite:///./stocks.db`.
**How to avoid:** Update `sqlalchemy.url` in `alembic.ini` OR use environment variable interpolation `%(DATABASE_URL)s` so Alembic reads from env.
**Warning signs:** `alembic upgrade head` succeeds but no tables appear in Supabase dashboard.

### Pitfall 5: `.env` with Real Credentials Committed
**What goes wrong:** Supabase credentials pushed to git.
**Why it happens:** `.env` not in `.gitignore`.
**How to avoid:** Verify `.gitignore` contains `.env` before creating the file with real credentials. Confirm `.env.example` (no real values) is the only committed file.

---

## Code Examples

### Complete database.py After Migration
```python
# Source: SQLAlchemy 2.0 async docs
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy.orm import DeclarativeBase
from .config import settings

engine = create_async_engine(settings.database_url, echo=False)
async_session_maker = async_sessionmaker(engine, expire_on_commit=False)

class Base(DeclarativeBase):
    pass

async def get_db() -> AsyncSession:
    async with async_session_maker() as session:
        yield session
```

### Scheduler Sync Engine After Migration
```python
# In scheduler.py — replace the current _sync_engine block
_sync_engine = create_engine(settings.sync_database_url)
# No connect_args needed for psycopg2 in a multi-threaded context
```

### config.py with sync_database_url Property
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    database_url: str
    fetch_interval_minutes: int = 5

    @property
    def sync_database_url(self) -> str:
        return self.database_url.replace("postgresql+asyncpg", "postgresql+psycopg2")

    class Config:
        env_file = ".env"

settings = Settings()
```

### alembic.ini URL (Option A — hardcoded, not committed)
```ini
sqlalchemy.url = postgresql+asyncpg://postgres:PASSWORD@db.PROJECT.supabase.co:5432/postgres
```

### alembic.ini URL (Option B — env var interpolation, recommended)
```ini
# In [alembic] section:
sqlalchemy.url = %(DATABASE_URL)s
```
Then in `env.py`, ensure env vars are loaded before Alembic reads config:
```python
# Add near top of env.py, before config is read
from dotenv import load_dotenv
load_dotenv()
```

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| `gotrue` Python package | `supabase-auth` (`supabase_auth`) | Deprecated August 2025 | Use `supabase-auth` for Phase 4 auth, not `gotrue` |
| pgbouncer (self-hosted) | Supavisor (Supabase's pooler) | 2023-2024 | Supabase now uses Supavisor; same behavioral constraints apply |
| `psycopg2` for Alembic migrations | `asyncpg` with async `env.py` | SQLAlchemy 2.0 era | Current Alembic env.py already uses the correct async approach |

**Deprecated/outdated:**
- `aiosqlite`: No longer needed once database_url points to Postgres.
- `connect_args={"check_same_thread": False}`: SQLite-only, must be removed.
- `PRAGMA journal_mode=WAL`: SQLite-only, must be removed.

---

## Open Questions

1. **Alembic URL strategy: hardcode in alembic.ini vs env var interpolation**
   - What we know: Both work. Env var approach (`%(DATABASE_URL)s`) avoids duplicating credentials.
   - What's unclear: Whether the existing `env.py` loads `.env` before Alembic reads config (it does NOT currently import dotenv).
   - Recommendation: Add `load_dotenv()` to `env.py` and use `%(DATABASE_URL)s` in `alembic.ini`. This is cleaner than hardcoding.

2. **Whether `backend/.env` is already in `.gitignore`**
   - What we know: `.env.example` exists; a real `.env` likely exists locally.
   - What's unclear: Whether `.gitignore` covers it.
   - Recommendation: Planner should add a verification step to check `.gitignore`.

---

## Sources

### Primary (HIGH confidence)
- [SQLAlchemy 2.0 asyncio docs](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html) — async engine creation, session patterns
- [SQLAlchemy 2.0 PostgreSQL dialect](https://docs.sqlalchemy.org/en/20/dialects/postgresql.html) — asyncpg connection string format
- [SQLAlchemy 2.0 engine configuration](https://docs.sqlalchemy.org/en/20/core/engines.html) — sync engine, pool options
- [Supabase connecting to Postgres docs](https://supabase.com/docs/guides/database/connecting-to-postgres) — port 5432 vs 6543, session vs transaction mode
- [Supabase SQLAlchemy troubleshooting](https://supabase.com/docs/guides/troubleshooting/using-sqlalchemy-with-supabase-FUqebT) — NullPool for transaction mode

### Secondary (MEDIUM confidence)
- [Supabase disabling prepared statements](https://supabase.com/docs/guides/troubleshooting/disabling-prepared-statements-qL8lEL) — `statement_cache_size=0` for pgbouncer transaction mode
- [asyncpg FAQ](https://magicstack.github.io/asyncpg/current/faq.html) — prepared statement cache configuration
- [SQLAlchemy issue #6467](https://github.com/sqlalchemy/sqlalchemy/issues/6467) — `statement_cache_size` with pgbouncer
- [supabase-auth PyPI](https://pypi.org/project/supabase-auth/) — replacement for deprecated `gotrue` package

### Tertiary (LOW confidence)
- [Supabase pooling and asyncpg Medium article](https://medium.com/@patrickduch93/supabase-pooling-and-asyncpg-dont-mix-here-s-the-real-fix-44f700b05249) — practical pgbouncer workaround patterns (community source, not official)

---

## Metadata

**Confidence breakdown:**
- Standard stack (asyncpg, psycopg2-binary): HIGH — verified against SQLAlchemy 2.0 official docs
- Port 5432 vs 6543 recommendation: HIGH — verified against Supabase official docs; direct connection recommended for static servers
- Alembic async env.py compatibility: HIGH — existing code already uses correct pattern; no changes needed
- `check_same_thread` pitfall: HIGH — well-documented SQLite-specific argument
- WAL listener pitfall: HIGH — PRAGMA is SQLite-only syntax, trivially verified
- Supabase Auth Phase 4 note: HIGH — `gotrue` deprecation is official Supabase announcement (August 2025)

**Research date:** 2026-02-18
**Valid until:** 2026-03-18 (Supabase infrastructure config is stable; SQLAlchemy 2.0 API is stable)
