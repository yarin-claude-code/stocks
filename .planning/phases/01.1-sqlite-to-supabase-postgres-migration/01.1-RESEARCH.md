# Phase 01.1: SQLite → Supabase Migration — Research Summary

**Date:** 2026-02-18 | **Status:** COMPLETE (implemented)

## Key Findings

| Topic | Finding |
|-------|---------|
| Port | Use **5432** (direct). NOT 6543 (pgbouncer/Supavisor) — transaction pooler breaks asyncpg prepared statements |
| Async driver | `asyncpg>=0.29` replaces `aiosqlite` |
| Sync driver | `psycopg2-binary>=2.9` for APScheduler engine |
| URL derivation | Derive sync URL in `config.py` via `.replace("postgresql+asyncpg", "postgresql+psycopg2")` — one env var |
| WAL listener | DELETE the `event.listens_for` WAL block — `PRAGMA` is SQLite-only, crashes on Postgres |
| check_same_thread | REMOVE from `create_engine()` — SQLite-only arg, raises `TypeError` on psycopg2 |
| Alembic | `async_engine_from_config` works identically with asyncpg — no code changes needed |
| Alembic URL | Inject via `config.set_main_option()` after `load_dotenv()` — configparser can't read env vars |
| Auth (Phase 4) | Use `supabase-auth` — `gotrue` deprecated August 2025 |

## Pitfalls

- Port 6543 → `asyncpg.exceptions.InvalidSQLStatementNameError` under concurrent load
- Leaving `connect_args={"check_same_thread": False}` → `TypeError` on startup
- Leaving WAL PRAGMA → `SyntaxOrAccessError` on first connection
- `.env` not in `.gitignore` → credentials committed to git
- `alembic.ini` not updated → migrations run against old SQLite file

## What Changed

`aiosqlite` removed → `asyncpg` + `psycopg2-binary` added. WAL listener deleted. `check_same_thread` removed. `config.py` gains `sync_database_url` property.
