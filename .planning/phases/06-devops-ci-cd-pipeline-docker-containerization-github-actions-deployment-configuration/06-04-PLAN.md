---
phase: 06-devops
plan: "04"
type: execute
wave: 2
depends_on: ["06-01", "06-02", "06-03"]
files_modified: []
autonomous: false
requirements: []

must_haves:
  truths:
    - "A PR pushed to the repo triggers the CI workflow in GitHub Actions"
    - "All four jobs run and pass (lint, test-backend, test-e2e, docker)"
    - "Branch protection on main blocks merging PRs where CI fails"
    - "DATABASE_URL GitHub secret is set for the test-e2e job (backend startup)"
  artifacts: []
  key_links:
    - from: "GitHub branch protection rule"
      to: ".github/workflows/ci.yml"
      via: "required status checks: lint, test-backend, test-e2e, docker"
---

<objective>
Verify CI runs end-to-end in GitHub and configure branch protection on main.

Purpose: Proves the entire pipeline works in real GitHub Actions, not just locally. Branch protection enforces the PR policy.
Output: Confirmed working CI run + branch protection active on main.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-devops-ci-cd-pipeline-docker-containerization-github-actions-deployment-configuration/06-01-SUMMARY.md
@.planning/phases/06-devops-ci-cd-pipeline-docker-containerization-github-actions-deployment-configuration/06-02-SUMMARY.md
@.planning/phases/06-devops-ci-cd-pipeline-docker-containerization-github-actions-deployment-configuration/06-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Push branch and open a test PR</name>
  <files></files>
  <action>
Commit all Phase 6 artifacts on the current branch if not already committed. Then push the branch and open a PR against main via `gh pr create`. The PR triggers CI automatically.

```bash
git push origin HEAD
gh pr create --title "feat(devops): CI/CD pipeline, Docker, Playwright" --body "Phase 6: GitHub Actions CI, Docker multi-stage builds, Playwright smoke test, branch protection."
```

After creating the PR, monitor CI:
```bash
gh run list --limit 5
gh run watch  # (or check GitHub Actions tab in browser)
```

If any job fails, read the logs and fix the issue before proceeding:
```bash
gh run view --log-failed
```
  </action>
  <verify>gh run list --limit 1 — shows a completed run with status 'success' OR shows failure details to fix</verify>
  <done>GitHub Actions run completes with all four jobs green (lint, test-backend, test-e2e, docker)</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    GitHub Actions CI workflow running all four stages. Docker images built (and pushed to ghcr.io if on main).
  </what-built>
  <how-to-verify>
    1. Open the PR on GitHub — check the "Checks" tab shows all four jobs passing
    2. Go to repo Settings → Branches → Add branch protection rule for `main`:
       - Check "Require status checks to pass before merging"
       - Search for and add required checks: `Lint`, `Backend Tests`, `E2E Tests (Playwright)`, `Docker Build & Push`
       - Check "Require branches to be up to date before merging"
       - Save the rule
    3. Add the DATABASE_URL secret if not already set:
       - Go to repo Settings → Secrets and variables → Actions → New repository secret
       - Name: `DATABASE_URL`, Value: your Supabase connection string (postgresql+asyncpg://...)
    4. Confirm: attempt to merge a PR with a failing check is blocked by GitHub
  </how-to-verify>
  <resume-signal>Type "approved" when CI is green and branch protection is configured, or describe any failures</resume-signal>
</task>

</tasks>

<verification>
- All four CI jobs green on GitHub Actions
- Branch protection rule active on main with all four status checks required
- DATABASE_URL secret set in repo settings
</verification>

<success_criteria>
Any PR to main that fails lint, pytest, E2E, or Docker build is blocked from merging. Docker images pushed to ghcr.io on merge to main.
</success_criteria>

<output>
After completion, create `.planning/phases/06-devops-ci-cd-pipeline-docker-containerization-github-actions-deployment-configuration/06-04-SUMMARY.md`
</output>
