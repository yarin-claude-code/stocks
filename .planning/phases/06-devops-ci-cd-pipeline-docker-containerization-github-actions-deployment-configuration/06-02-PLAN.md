---
phase: 06-devops
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - backend/ruff.toml
autonomous: true
requirements: []

must_haves:
  truths:
    - "CI workflow triggers on every pull_request and on push to main"
    - "lint job runs ruff check on backend/ and eslint on frontend/"
    - "test-backend job runs pytest — no live DB needed (tests are mocked)"
    - "docker job builds both images; pushes only on main branch merge"
    - "Each job uses needs: so failures block downstream jobs"
    - "GITHUB_TOKEN used for ghcr.io auth — no PAT secret required"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Four-job CI pipeline: lint → test-backend → test-e2e → docker"
    - path: "backend/ruff.toml"
      provides: "ruff configuration — line length, select rules"
  key_links:
    - from: "test-e2e job"
      to: "lint + test-backend jobs"
      via: "needs: [lint, test-backend]"
    - from: "docker job"
      to: "test-e2e job"
      via: "needs: [test-e2e]"
    - from: "docker/build-push-action"
      to: "ghcr.io"
      via: "push: ${{ github.ref == 'refs/heads/main' }}"
---

<objective>
Create the GitHub Actions CI workflow and ruff config.

Purpose: Automated lint, test, and Docker build on every PR. Image push to ghcr.io on main merge only.
Output: .github/workflows/ci.yml, backend/ruff.toml
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: ruff configuration</name>
  <files>backend/ruff.toml</files>
  <action>
Create `backend/ruff.toml`:

```toml
line-length = 100

[lint]
select = ["E", "F", "I"]
# E = pycodestyle errors, F = pyflakes, I = isort
ignore = ["E501"]  # line too long — covered by line-length
```

This is intentionally permissive — purpose is catching real errors (undefined names, unused imports) not enforcing style wars. Do NOT add ruff to requirements.txt; it will be installed in CI via `pip install ruff`.
  </action>
  <verify>cd backend && pip install ruff && ruff check . (should pass or show only fixable warnings, not errors)</verify>
  <done>ruff.toml exists; `ruff check backend/` exits 0 (or exits with warnings only, no hard errors that would fail CI)</done>
</task>

<task type="auto">
  <name>Task 2: GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/` and `.github/workflows/` directories if they don't exist, then create `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Lint backend (ruff)
        run: |
          pip install ruff
          ruff check backend/

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Lint frontend (eslint)
        working-directory: frontend
        run: |
          npm ci
          npm run lint

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        working-directory: backend
        run: pip install -r requirements.txt
      - name: Run pytest
        working-directory: backend
        run: python -m pytest tests/ -v
        # No DATABASE_URL needed — all tests mock yfinance and DB calls

  test-e2e:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: [lint, test-backend]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install backend dependencies
        working-directory: backend
        run: pip install -r requirements.txt
      - name: Start backend
        working-directory: backend
        run: uvicorn app.main:app --host 0.0.0.0 --port 8001 &
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FETCH_INTERVAL_MINUTES: "999"

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci
      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install chromium --with-deps
      - name: Wait for backend
        run: sleep 5
      - name: Run Playwright tests
        working-directory: frontend
        run: npx playwright test
        env:
          BASE_URL: http://localhost:8001

  docker:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [test-e2e]
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Backend image metadata
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/backend
          tags: |
            type=sha
            type=ref,event=branch

      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Frontend image metadata
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/frontend
          tags: |
            type=sha
            type=ref,event=branch

      - name: Build & push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

Notes on decisions:
- `needs: [lint, test-backend]` on test-e2e — both must pass before E2E starts
- `needs: [test-e2e]` on docker — all tests must pass before build
- `push: ${{ github.ref == 'refs/heads/main' }}` — PR runs build-only, no registry push
- `FETCH_INTERVAL_MINUTES: "999"` — prevents scheduler from actually running during E2E
- GHA cache (`cache-from/cache-to: type=gha`) speeds up repeated Docker builds
- `permissions: packages: write` at workflow level covers all jobs
  </action>
  <verify>cat .github/workflows/ci.yml (confirm file exists and YAML is valid structure)</verify>
  <done>.github/workflows/ci.yml exists with all four jobs (lint, test-backend, test-e2e, docker) and correct needs: chains</done>
</task>

</tasks>

<verification>
- `.github/workflows/ci.yml` exists with four jobs
- `backend/ruff.toml` exists
- `ruff check backend/` passes locally
- YAML structure: lint → test-backend → test-e2e → docker (check needs: fields)
</verification>

<success_criteria>
ci.yml has four jobs with correct needs: chaining. Docker push gated on `github.ref == 'refs/heads/main'`. GITHUB_TOKEN used for registry auth. ruff.toml exists and local ruff check passes.
</success_criteria>

<output>
After completion, create `.planning/phases/06-devops-ci-cd-pipeline-docker-containerization-github-actions-deployment-configuration/06-02-SUMMARY.md`
</output>
