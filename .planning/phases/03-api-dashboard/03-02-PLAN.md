---
phase: 03-api-dashboard
plan: "02"
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/app/routers/rankings.py
  - backend/app/routers/domains.py
  - backend/app/main.py
autonomous: true
requirements: [DOM-01, DOM-02]

must_haves:
  truths:
    - "GET /api/domains returns list of domain names"
    - "GET /api/rankings returns top 5 per domain + best_overall + last_fetched"
    - "GET /api/rankings/{domain} returns all ranked stocks in that domain with factor breakdown"
    - "All routes handle empty ranking_results (returns empty domains list, null best_overall)"
    - "CORS allows http://localhost:5173"
  artifacts:
    - path: "backend/app/routers/rankings.py"
      provides: "GET /api/rankings and GET /api/rankings/{domain}"
      exports: ["router"]
    - path: "backend/app/routers/domains.py"
      provides: "GET /api/domains"
      exports: ["router"]
  key_links:
    - from: "backend/app/routers/rankings.py"
      to: "backend/app/models/ranking_result.py"
      via: "async DB query for latest computed_at per ticker"
      pattern: "RankingResult"
    - from: "backend/app/main.py"
      to: "backend/app/routers/rankings.py"
      via: "app.include_router"
      pattern: "include_router.*rankings"
---

<objective>
Add FastAPI routes for domains and rankings, plus CORS middleware.

Purpose: Frontend (plan 03) needs these endpoints. Routes query ranking_results for the latest snapshot per ticker.
Output: /api/domains, /api/rankings, /api/rankings/{domain} endpoints + CORS.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@backend/app/routers/health.py
@backend/app/models/ranking_result.py
@backend/app/models/stock.py
@backend/app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pydantic models + /api/domains + /api/rankings routes</name>
  <files>backend/app/routers/domains.py, backend/app/routers/rankings.py</files>
  <action>
**backend/app/routers/domains.py** — Query Domain table, return list of names:
```python
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from ..database import get_db
from ..models.stock import Domain

router = APIRouter(prefix="/api", tags=["domains"])

@router.get("/domains")
async def list_domains(db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(Domain.name).order_by(Domain.name))
    return {"domains": result.scalars().all()}
```

**backend/app/routers/rankings.py** — Define Pydantic models and two routes:

Pydantic models:
```python
from pydantic import BaseModel
from datetime import datetime

class FactorBreakdown(BaseModel):
    momentum: float | None
    volume_change: float | None
    volatility: float | None
    relative_strength: float | None
    financial_ratio: float | None

class StockRanking(BaseModel):
    ticker: str
    composite_score: float
    rank: int
    factors: FactorBreakdown
    computed_at: datetime

class DomainRankings(BaseModel):
    domain: str
    top5: list[StockRanking]

class RankingsResponse(BaseModel):
    domains: list[DomainRankings]
    best_overall: StockRanking | None
    last_fetched: datetime | None
```

GET /api/rankings logic:
- Query ranking_results for the latest computed_at (subquery: max computed_at overall)
- Filter rows WHERE computed_at == latest_computed_at
- Group by domain, sort by rank ASC, take top 5 per domain
- best_overall = row with highest composite_score across all domains
- last_fetched = latest computed_at

GET /api/rankings/{domain} logic:
- Query ranking_results for latest computed_at, filter by domain
- Return all rows (not just top 5), sorted by rank ASC
- 404 if domain not found or no data

Use SQLAlchemy async session (get_db dependency). Use subquery for latest computed_at:
```python
from sqlalchemy import select, func
latest_q = select(func.max(RankingResult.computed_at)).scalar_subquery()
rows = (await db.execute(
    select(RankingResult).where(RankingResult.computed_at == latest_q)
)).scalars().all()
```

Return empty domains list (not error) if no rows exist yet.
  </action>
  <verify>
```bash
cd backend && python -c "from app.routers.rankings import router; from app.routers.domains import router as dr; print('ok')"
```
  </verify>
  <done>Both routers importable with correct route signatures.</done>
</task>

<task type="auto">
  <name>Task 2: Register routers + CORS in main.py</name>
  <files>backend/app/main.py</files>
  <action>
Add CORSMiddleware and include new routers in main.py:

```python
from fastapi.middleware.cors import CORSMiddleware
from .routers.rankings import router as rankings_router
from .routers.domains import router as domains_router

# After app = FastAPI(...):
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],
    allow_methods=["GET"],
    allow_headers=["*"],
)
app.include_router(health_router)
app.include_router(rankings_router)
app.include_router(domains_router)
```
  </action>
  <verify>
```bash
cd backend && uvicorn app.main:app --reload &
sleep 3
curl http://localhost:8000/api/domains
curl http://localhost:8000/api/rankings
curl -H "Origin: http://localhost:5173" -I http://localhost:8000/api/domains | grep -i access-control
```
Domains returns JSON. Rankings returns JSON (may have empty domains if no fetch_cycle run yet). CORS header present.
  </verify>
  <done>GET /api/domains, /api/rankings, /api/rankings/{domain} all return valid JSON. CORS header Access-Control-Allow-Origin present for localhost:5173.</done>
</task>

</tasks>

<verification>
```bash
curl http://localhost:8000/api/domains
curl http://localhost:8000/api/rankings
curl http://localhost:8000/api/rankings/Finance
curl -H "Origin: http://localhost:5173" -I http://localhost:8000/api/rankings
```
All return 200 with valid JSON. CORS header present.
</verification>

<success_criteria>
- /api/domains returns {domains: [...]} with all seeded domain names
- /api/rankings returns {domains: [...], best_overall: ...|null, last_fetched: ...|null}
- /api/rankings/{domain} returns ranked stocks with factor breakdown
- Unknown domain returns 404
- CORS allows http://localhost:5173
</success_criteria>

<output>
After completion, create `.planning/phases/03-api-dashboard/03-02-SUMMARY.md`
</output>
